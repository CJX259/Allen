!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).TXLivePusher=t()}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};function t(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var n=function(){return(n=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function r(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function i(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function o(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function s(e){var t={exports:{}};return e(t,t.exports),t.exports}s((function(e,t){!function(e){var t="undefined"!=typeof globalThis&&globalThis||"undefined"!=typeof self&&self||void 0!==t&&t,n={searchParams:"URLSearchParams"in t,iterable:"Symbol"in t&&"iterator"in Symbol,blob:"FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(e){return!1}}(),formData:"FormData"in t,arrayBuffer:"ArrayBuffer"in t};function r(e){return e&&DataView.prototype.isPrototypeOf(e)}if(n.arrayBuffer)var i=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],o=ArrayBuffer.isView||function(e){return e&&i.indexOf(Object.prototype.toString.call(e))>-1};function s(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(e)||""===e)throw new TypeError('Invalid character in header field name: "'+e+'"');return e.toLowerCase()}function a(e){return"string"!=typeof e&&(e=String(e)),e}function c(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return n.iterable&&(t[Symbol.iterator]=function(){return t}),t}function d(e){this.map={},e instanceof d?e.forEach((function(e,t){this.append(t,e)}),this):Array.isArray(e)?e.forEach((function(e){this.append(e[0],e[1])}),this):e&&Object.getOwnPropertyNames(e).forEach((function(t){this.append(t,e[t])}),this)}function l(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function p(e){return new Promise((function(t,n){e.onload=function(){t(e.result)},e.onerror=function(){n(e.error)}}))}function u(e){var t=new FileReader,n=p(t);return t.readAsArrayBuffer(e),n}function h(e){var t=new FileReader,n=p(t);return t.readAsText(e),n}function f(e){for(var t=new Uint8Array(e),n=new Array(t.length),r=0;r<t.length;r++)n[r]=String.fromCharCode(t[r]);return n.join("")}function m(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function v(){return this.bodyUsed=!1,this._initBody=function(e){this.bodyUsed=this.bodyUsed,this._bodyInit=e,e?"string"==typeof e?this._bodyText=e:n.blob&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:n.formData&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:n.searchParams&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():n.arrayBuffer&&n.blob&&r(e)?(this._bodyArrayBuffer=m(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):n.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(e)||o(e))?this._bodyArrayBuffer=m(e):this._bodyText=e=Object.prototype.toString.call(e):this._bodyText="",this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):n.searchParams&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},n.blob&&(this.blob=function(){var e=l(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){if(this._bodyArrayBuffer){var e=l(this);return e||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}return this.blob().then(u)}),this.text=function(){var e=l(this);if(e)return e;if(this._bodyBlob)return h(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(f(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},n.formData&&(this.formData=function(){return this.text().then(C)}),this.json=function(){return this.text().then(JSON.parse)},this}d.prototype.append=function(e,t){e=s(e),t=a(t);var n=this.map[e];this.map[e]=n?n+", "+t:t},d.prototype.delete=function(e){delete this.map[s(e)]},d.prototype.get=function(e){return e=s(e),this.has(e)?this.map[e]:null},d.prototype.has=function(e){return this.map.hasOwnProperty(s(e))},d.prototype.set=function(e,t){this.map[s(e)]=a(t)},d.prototype.forEach=function(e,t){for(var n in this.map)this.map.hasOwnProperty(n)&&e.call(t,this.map[n],n,this)},d.prototype.keys=function(){var e=[];return this.forEach((function(t,n){e.push(n)})),c(e)},d.prototype.values=function(){var e=[];return this.forEach((function(t){e.push(t)})),c(e)},d.prototype.entries=function(){var e=[];return this.forEach((function(t,n){e.push([n,t])})),c(e)},n.iterable&&(d.prototype[Symbol.iterator]=d.prototype.entries);var y=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function g(e){var t=e.toUpperCase();return y.indexOf(t)>-1?t:e}function S(e,t){if(!(this instanceof S))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');var n=(t=t||{}).body;if(e instanceof S){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new d(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,n||null==e._bodyInit||(n=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new d(t.headers)),this.method=g(t.method||this.method||"GET"),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&n)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(n),!("GET"!==this.method&&"HEAD"!==this.method||"no-store"!==t.cache&&"no-cache"!==t.cache)){var r=/([?&])_=[^&]*/;if(r.test(this.url))this.url=this.url.replace(r,"$1_="+(new Date).getTime());else{var i=/\?/;this.url+=(i.test(this.url)?"&":"?")+"_="+(new Date).getTime()}}}function C(e){var t=new FormData;return e.trim().split("&").forEach((function(e){if(e){var n=e.split("="),r=n.shift().replace(/\+/g," "),i=n.join("=").replace(/\+/g," ");t.append(decodeURIComponent(r),decodeURIComponent(i))}})),t}function T(e){var t=new d;return e.replace(/\r?\n[\t ]+/g," ").split("\r").map((function(e){return 0===e.indexOf("\n")?e.substr(1,e.length):e})).forEach((function(e){var n=e.split(":"),r=n.shift().trim();if(r){var i=n.join(":").trim();t.append(r,i)}})),t}function E(e,t){if(!(this instanceof E))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');t||(t={}),this.type="default",this.status=void 0===t.status?200:t.status,this.ok=this.status>=200&&this.status<300,this.statusText=void 0===t.statusText?"":""+t.statusText,this.headers=new d(t.headers),this.url=t.url||"",this._initBody(e)}S.prototype.clone=function(){return new S(this,{body:this._bodyInit})},v.call(S.prototype),v.call(E.prototype),E.prototype.clone=function(){return new E(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new d(this.headers),url:this.url})},E.error=function(){var e=new E(null,{status:0,statusText:""});return e.type="error",e};var b=[301,302,303,307,308];E.redirect=function(e,t){if(-1===b.indexOf(t))throw new RangeError("Invalid status code");return new E(null,{status:t,headers:{location:e}})},e.DOMException=t.DOMException;try{new e.DOMException}catch(t){e.DOMException=function(e,t){this.message=e,this.name=t;var n=Error(e);this.stack=n.stack},e.DOMException.prototype=Object.create(Error.prototype),e.DOMException.prototype.constructor=e.DOMException}function R(r,i){return new Promise((function(o,s){var c=new S(r,i);if(c.signal&&c.signal.aborted)return s(new e.DOMException("Aborted","AbortError"));var l=new XMLHttpRequest;function p(){l.abort()}function u(e){try{return""===e&&t.location.href?t.location.href:e}catch(t){return e}}l.onload=function(){var e={status:l.status,statusText:l.statusText,headers:T(l.getAllResponseHeaders()||"")};e.url="responseURL"in l?l.responseURL:e.headers.get("X-Request-URL");var t="response"in l?l.response:l.responseText;setTimeout((function(){o(new E(t,e))}),0)},l.onerror=function(){setTimeout((function(){s(new TypeError("Network request failed"))}),0)},l.ontimeout=function(){setTimeout((function(){s(new TypeError("Network request failed"))}),0)},l.onabort=function(){setTimeout((function(){s(new e.DOMException("Aborted","AbortError"))}),0)},l.open(c.method,u(c.url),!0),"include"===c.credentials?l.withCredentials=!0:"omit"===c.credentials&&(l.withCredentials=!1),"responseType"in l&&(n.blob?l.responseType="blob":n.arrayBuffer&&c.headers.get("Content-Type")&&-1!==c.headers.get("Content-Type").indexOf("application/octet-stream")&&(l.responseType="arraybuffer")),!i||"object"!=typeof i.headers||i.headers instanceof d?c.headers.forEach((function(e,t){l.setRequestHeader(t,e)})):Object.getOwnPropertyNames(i.headers).forEach((function(e){l.setRequestHeader(e,a(i.headers[e]))})),c.signal&&(c.signal.addEventListener("abort",p),l.onreadystatechange=function(){4===l.readyState&&c.signal.removeEventListener("abort",p)}),l.send(void 0===c._bodyInit?null:c._bodyInit)}))}R.polyfill=!0,t.fetch||(t.fetch=R,t.Headers=d,t.Request=S,t.Response=E),e.Headers=d,e.Request=S,e.Response=E,e.fetch=R,Object.defineProperty(e,"__esModule",{value:!0})}(t)}));let a=!0,c=!0;function d(e,t,n){const r=e.match(t);return r&&r.length>=n&&parseInt(r[n],10)}function l(e,t,n){if(!e.RTCPeerConnection)return;const r=e.RTCPeerConnection.prototype,i=r.addEventListener;r.addEventListener=function(e,r){if(e!==t)return i.apply(this,arguments);const o=e=>{const t=n(e);t&&(r.handleEvent?r.handleEvent(t):r(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(r,o),i.apply(this,[e,o])};const o=r.removeEventListener;r.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(n))return o.apply(this,arguments);const r=this._eventMap[t].get(n);return this._eventMap[t].delete(n),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[e,r])},Object.defineProperty(r,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function p(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(a=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function u(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(c=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function h(){if("object"==typeof window){if(a)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function f(e,t){c&&console.warn(e+" is deprecated, please use "+t+" instead.")}function m(e){return"[object Object]"===Object.prototype.toString.call(e)}function v(e){return m(e)?Object.keys(e).reduce((function(t,n){const r=m(e[n]),i=r?v(e[n]):e[n],o=r&&!Object.keys(i).length;return void 0===i||o?t:Object.assign(t,{[n]:i})}),{}):e}function y(e,t,n){t&&!n.has(t.id)&&(n.set(t.id,t),Object.keys(t).forEach((r=>{r.endsWith("Id")?y(e,e.get(t[r]),n):r.endsWith("Ids")&&t[r].forEach((t=>{y(e,e.get(t),n)}))})))}function g(e,t,n){const r=n?"outbound-rtp":"inbound-rtp",i=new Map;if(null===t)return i;const o=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)})),o.forEach((t=>{e.forEach((n=>{n.type===r&&n.trackId===t.id&&y(e,n,i)}))})),i}const S=h;function C(e,t){const n=e&&e.navigator;if(!n.mediaDevices)return;const r=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((n=>{if("require"===n||"advanced"===n||"mediaSource"===n)return;const r="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);const i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==r.ideal){t.optional=t.optional||[];let e={};"number"==typeof r.ideal?(e[i("min",n)]=r.ideal,t.optional.push(e),e={},e[i("max",n)]=r.ideal,t.optional.push(e)):(e[i("",n)]=r.ideal,t.optional.push(e))}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",n)]=r.exact):["min","max"].forEach((e=>{void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,n)]=r[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},i=function(e,i){if(t.version>=61)return i(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=r(e.audio)}if(e&&"object"==typeof e.video){let o=e.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const s=t.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||s)){let t;if(delete e.video.facingMode,"environment"===o.exact||"environment"===o.ideal?t=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(t=["front"]),t)return n.mediaDevices.enumerateDevices().then((n=>{let s=(n=n.filter((e=>"videoinput"===e.kind))).find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!s&&n.length&&t.includes("back")&&(s=n[n.length-1]),s&&(e.video.deviceId=o.exact?{exact:s.deviceId}:{ideal:s.deviceId}),e.video=r(e.video),S("chrome: "+JSON.stringify(e)),i(e)}))}e.video=r(e.video)}return S("chrome: "+JSON.stringify(e)),i(e)},o=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=function(e,t,r){i(e,(e=>{n.webkitGetUserMedia(e,t,(e=>{r&&r(o(e))}))}))}.bind(n),n.mediaDevices.getUserMedia){const e=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(t){return i(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(o(e))))))}}}function T(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function E(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(n=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===n.track.id)):{track:n.track};const i=new Event("track");i.track=n.track,i.receiver=r,i.transceiver={receiver:r},i.streams=[t.stream],this.dispatchEvent(i)})),t.stream.getTracks().forEach((n=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===n.id)):{track:n};const i=new Event("track");i.track=n,i.receiver=r,i.transceiver={receiver:r},i.streams=[t.stream],this.dispatchEvent(i)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else l(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function b(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){let i=n.apply(this,arguments);return i||(i=t(this,e),this._senders.push(i)),i};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){r.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function R(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,r]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const i=function(e){const t={};return e.result().forEach((e=>{const n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{n[t]=e.stat(t)})),t[n.id]=n})),t},o=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const r=function(e){n(o(i(e)))};return t.apply(this,[r,e])}return new Promise(((e,n)=>{t.apply(this,[function(t){e(o(i(t)))},n])})).then(n,r)}}function w(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>g(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),l(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>g(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,n,r;return this.getSenders().forEach((n=>{n.track===e&&(t?r=!0:t=n)})),this.getReceivers().forEach((t=>(t.track===e&&(n?r=!0:n=t),t.track===e))),r||t&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function P(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){if(!n)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const r=t.apply(this,arguments);return this._shimmedLocalStreams[n.id]?-1===this._shimmedLocalStreams[n.id].indexOf(r)&&this._shimmedLocalStreams[n.id].push(r):this._shimmedLocalStreams[n.id]=[n,r],r};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();n.apply(this,arguments);const r=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(r)};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],r.apply(this,arguments)};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const n=this._shimmedLocalStreams[t].indexOf(e);-1!==n&&this._shimmedLocalStreams[t].splice(n,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),i.apply(this,arguments)}}function _(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return P(e);const n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=n.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const n=new e.MediaStream(t.getTracks());this._streams[t.id]=n,this._reverseStreams[n.id]=t,t=n}r.apply(this,[t])};const i=e.RTCPeerConnection.prototype.removeStream;function o(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const r=e._reverseStreams[t],i=e._streams[r.id];n=n.replace(new RegExp(i.id,"g"),r.id)})),new RTCSessionDescription({type:t.type,sdp:n})}function s(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const r=e._reverseStreams[t],i=e._streams[r.id];n=n.replace(new RegExp(r.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:n})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const r=[].slice.call(arguments,1);if(1!==r.length||!r[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const i=this.getSenders().find((e=>e.track===t));if(i)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const o=this._streams[n.id];if(o)o.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const r=new e.MediaStream([t]);this._streams[n.id]=r,this._reverseStreams[r.id]=n,this.addStream(r)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],r={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?n.apply(this,[t=>{const n=o(this,t);e[0].apply(null,[n])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):n.apply(this,arguments).then((e=>o(this,e)))}};e.RTCPeerConnection.prototype[t]=r[t]}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=s(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((n=>{this._streams[n].getTracks().find((t=>e.track===t))&&(t=this._streams[n])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function k(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=r[t]}))}function D(e,t){l(e,"negotiationneeded",(e=>{const n=e.target;if(!(t.version<72||n.getConfiguration&&"plan-b"===n.getConfiguration().sdpSemantics)||"stable"===n.signalingState)return e}))}var I=Object.freeze({__proto__:null,shimMediaStream:T,shimOnTrack:E,shimGetSendersWithDtmf:b,shimGetStats:R,shimSenderReceiverGetStats:w,shimAddTrackRemoveTrackWithNative:P,shimAddTrackRemoveTrack:_,shimPeerConnection:k,fixNegotiationNeeded:D,shimGetUserMedia:C,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(n){return t(n).then((t=>{const r=n.video&&n.video.width,i=n.video&&n.video.height,o=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:o||3}},r&&(n.video.mandatory.maxWidth=r),i&&(n.video.mandatory.maxHeight=i),e.navigator.mediaDevices.getUserMedia(n)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}});var x=s((function(e){var t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},t.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},t.getDescription=function(e){var n=t.splitSections(e);return n&&n[0]},t.getMediaSections=function(e){var n=t.splitSections(e);return n.shift(),n},t.matchPrefix=function(e,n){return t.splitLines(e).filter((function(e){return 0===e.indexOf(n)}))},t.parseCandidate=function(e){for(var t,n={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},r=8;r<t.length;r+=2)switch(t[r]){case"raddr":n.relatedAddress=t[r+1];break;case"rport":n.relatedPort=parseInt(t[r+1],10);break;case"tcptype":n.tcpType=t[r+1];break;case"ufrag":n.ufrag=t[r+1],n.usernameFragment=t[r+1];break;default:n[t[r]]=t[r+1]}return n},t.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.channels=3===t.length?parseInt(t[2],10):1,n.numChannels=n.channels,n},t.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var n=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},t.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){for(var t,n={},r=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<r.length;i++)n[(t=r[i].trim().split("="))[0].trim()]=t[1];return n},t.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var r=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?r.push(t+"="+e.parameters[t]):r.push(t)})),t+="a=fmtp:"+n+" "+r.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},r=e.indexOf(":",t);return r>-1?(n.attribute=e.substr(t+1,r-t-1),n.value=e.substr(r+1)):n.attribute=e.substr(t+1),n},t.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},t.getMid=function(e){var n=t.matchPrefix(e,"a=mid:")[0];if(n)return n.substr(6)},t.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,n){return{role:"auto",fingerprints:t.matchPrefix(e+n,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),n},t.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,n){return t.matchPrefix(e+n,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,n){var r=t.matchPrefix(e+n,"a=ice-ufrag:")[0],i=t.matchPrefix(e+n,"a=ice-pwd:")[0];return r&&i?{usernameFragment:r.substr(12),password:i.substr(10)}:null},t.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},t.parseRtpParameters=function(e){for(var n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(e)[0].split(" "),i=3;i<r.length;i++){var o=r[i],s=t.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(s){var a=t.parseRtpMap(s),c=t.matchPrefix(e,"a=fmtp:"+o+" ");switch(a.parameters=c.length?t.parseFmtp(c[0]):{},a.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(t.parseRtcpFb),n.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(a.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach((function(e){n.headerExtensions.push(t.parseExtmap(e))})),n},t.writeRtpDescription=function(e,n){var r="";r+="m="+e+" ",r+=n.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=n.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",n.codecs.forEach((function(e){r+=t.writeRtpMap(e),r+=t.writeFmtp(e),r+=t.writeRtcpFb(e)}));var i=0;return n.codecs.forEach((function(e){e.maxptime>i&&(i=e.maxptime)})),i>0&&(r+="a=maxptime:"+i+"\r\n"),r+="a=rtcp-mux\r\n",n.headerExtensions&&n.headerExtensions.forEach((function(e){r+=t.writeExtmap(e)})),r},t.parseRtpEncodingParameters=function(e){var n,r=[],i=t.parseRtpParameters(e),o=-1!==i.fecMechanisms.indexOf("RED"),s=-1!==i.fecMechanisms.indexOf("ULPFEC"),a=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=a.length>0&&a[0].ssrc,d=t.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));d.length>0&&d[0].length>1&&d[0][0]===c&&(n=d[0][1]),i.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&n&&(t.rtx={ssrc:n}),r.push(t),o&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},r.push(t))}})),0===r.length&&c&&r.push({ssrc:c});var l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,r.forEach((function(e){e.maxBitrate=l}))),r},t.parseRtcpParameters=function(e){var n={},r=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];r&&(n.cname=r.value,n.ssrc=r.ssrc);var i=t.matchPrefix(e,"a=rtcp-rsize");n.reducedSize=i.length>0,n.compound=0===i.length;var o=t.matchPrefix(e,"a=rtcp-mux");return n.mux=o.length>0,n},t.parseMsid=function(e){var n,r=t.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(n=r[0].substr(7).split(" "))[0],track:n[1]};var i=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return i.length>0?{stream:(n=i[0].value.split(" "))[0],track:n[1]}:void 0},t.parseSctpDescription=function(e){var n,r=t.parseMLine(e),i=t.matchPrefix(e,"a=max-message-size:");i.length>0&&(n=parseInt(i[0].substr(19),10)),isNaN(n)&&(n=65536);var o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substr(12),10),protocol:r.fmt,maxMessageSize:n};if(t.matchPrefix(e,"a=sctpmap:").length>0){var s=t.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(s[0],10),protocol:s[1],maxMessageSize:n}}},t.writeSctpDescription=function(e,t){var n=[];return n="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&n.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),n.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,n,r){var i=void 0!==n?n:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||t.generateSessionId())+" "+i+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.writeMediaSection=function(e,n,r,i){var o=t.writeRtpDescription(e.kind,n);if(o+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),o+="a=mid:"+e.mid+"\r\n",e.direction?o+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender){var s="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";o+="a="+s,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+"\r\n"),o},t.getDirection=function(e,n){for(var r=t.splitLines(e),i=0;i<r.length;i++)switch(r[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[i].substr(2)}return n?t.getDirection(n):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){var n=t.splitLines(e)[0].substr(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(e){var n=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var n=t.splitLines(e),r=0;r<n.length;r++)if(n[r].length<2||"="!==n[r].charAt(1))return!1;return!0},e.exports=t}));function A(e,t,n,r,i){var o=x.writeRtpDescription(e.kind,t);if(o+=x.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=x.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":i||"active"),o+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender){var s=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=s;var a="msid:"+(r?r.id:"-")+" "+s+"\r\n";o+="a="+a,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+x.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+x.localCName+"\r\n"),o}function O(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]},r=function(e,t){e=parseInt(e,10);for(var n=0;n<t.length;n++)if(t[n].payloadType===e||t[n].preferredPayloadType===e)return t[n]},i=function(e,t,n,i){var o=r(e.parameters.apt,n),s=r(t.parameters.apt,i);return o&&s&&o.name.toLowerCase()===s.name.toLowerCase()};return e.codecs.forEach((function(r){for(var o=0;o<t.codecs.length;o++){var s=t.codecs[o];if(r.name.toLowerCase()===s.name.toLowerCase()&&r.clockRate===s.clockRate){if("rtx"===r.name.toLowerCase()&&r.parameters&&s.parameters.apt&&!i(r,s,e.codecs,t.codecs))continue;(s=JSON.parse(JSON.stringify(s))).numChannels=Math.min(r.numChannels,s.numChannels),n.codecs.push(s),s.rtcpFeedback=s.rtcpFeedback.filter((function(e){for(var t=0;t<r.rtcpFeedback.length;t++)if(r.rtcpFeedback[t].type===e.type&&r.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var r=0;r<t.headerExtensions.length;r++){var i=t.headerExtensions[r];if(e.uri===i.uri){n.headerExtensions.push(i);break}}})),n}function L(e,t,n){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(n)}function N(e,t){var n=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return n||e.addRemoteCandidate(t),!n}function M(e,t){var n=new Error(t);return n.name=e,n.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],n}var j=function(e,t){function n(t,n){n.addTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function r(t,n,r,i){var o=new Event("track");o.track=n,o.receiver=r,o.transceiver={receiver:r},o.streams=i,e.setTimeout((function(){t._dispatchEvent("track",o)}))}var i=function(n){var r=this,i=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){r[e]=i[e].bind(i)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",n=JSON.parse(JSON.stringify(n||{})),this.usingBundle="max-bundle"===n.bundlePolicy,"negotiate"===n.rtcpMuxPolicy)throw M("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(n.rtcpMuxPolicy||(n.rtcpMuxPolicy="require"),n.iceTransportPolicy){case"all":case"relay":break;default:n.iceTransportPolicy="all"}switch(n.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:n.bundlePolicy="balanced"}if(n.iceServers=function(e,t){var n=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var r=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var i="string"==typeof r;return i&&(r=[r]),r=r.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||n?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(n=!0,!0)})),delete e.url,e.urls=i?r[0]:r,!!r.length}}))}(n.iceServers||[],t),this._iceGatherers=[],n.iceCandidatePoolSize)for(var o=n.iceCandidatePoolSize;o>0;o--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:n.iceServers,gatherPolicy:n.iceTransportPolicy}));else n.iceCandidatePoolSize=0;this._config=n,this.transceivers=[],this._sdpSessionId=x.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(i.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(i.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),i.prototype.onicecandidate=null,i.prototype.onaddstream=null,i.prototype.ontrack=null,i.prototype.onremovestream=null,i.prototype.onsignalingstatechange=null,i.prototype.oniceconnectionstatechange=null,i.prototype.onconnectionstatechange=null,i.prototype.onicegatheringstatechange=null,i.prototype.onnegotiationneeded=null,i.prototype.ondatachannel=null,i.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},i.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},i.prototype.getConfiguration=function(){return this._config},i.prototype.getLocalStreams=function(){return this.localStreams},i.prototype.getRemoteStreams=function(){return this.remoteStreams},i.prototype._createTransceiver=function(e,t){var n=this.transceivers.length>0,r={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&n)r.iceTransport=this.transceivers[0].iceTransport,r.dtlsTransport=this.transceivers[0].dtlsTransport;else{var i=this._createIceAndDtlsTransports();r.iceTransport=i.iceTransport,r.dtlsTransport=i.dtlsTransport}return t||this.transceivers.push(r),r},i.prototype.addTrack=function(t,n){if(this._isClosed)throw M("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var r;if(this.transceivers.find((function(e){return e.track===t})))throw M("InvalidAccessError","Track already exists.");for(var i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==t.kind||(r=this.transceivers[i]);return r||(r=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(n)&&this.localStreams.push(n),r.track=t,r.stream=n,r.rtpSender=new e.RTCRtpSender(t,r.dtlsTransport),r.rtpSender},i.prototype.addStream=function(e){var n=this;if(t>=15025)e.getTracks().forEach((function(t){n.addTrack(t,e)}));else{var r=e.clone();e.getTracks().forEach((function(e,t){var n=r.getTracks()[t];e.addEventListener("enabled",(function(e){n.enabled=e.enabled}))})),r.getTracks().forEach((function(e){n.addTrack(e,r)}))}},i.prototype.removeTrack=function(t){if(this._isClosed)throw M("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var n=this.transceivers.find((function(e){return e.rtpSender===t}));if(!n)throw M("InvalidAccessError","Sender was not created by this connection.");var r=n.stream;n.rtpSender.stop(),n.rtpSender=null,n.track=null,n.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(r)&&this.localStreams.indexOf(r)>-1&&this.localStreams.splice(this.localStreams.indexOf(r),1),this._maybeFireNegotiationNeeded()},i.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var n=t.getSenders().find((function(t){return t.track===e}));n&&t.removeTrack(n)}))},i.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},i.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},i.prototype._createIceGatherer=function(t,n){var r=this;if(n&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var i=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(i,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var n=!e.candidate||0===Object.keys(e.candidate).length;i.state=n?"completed":"gathering",null!==r.transceivers[t].bufferedCandidateEvents&&r.transceivers[t].bufferedCandidateEvents.push(e)},i.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),i},i.prototype._gather=function(t,n){var r=this,i=this.transceivers[n].iceGatherer;if(!i.onlocalcandidate){var o=this.transceivers[n].bufferedCandidateEvents;this.transceivers[n].bufferedCandidateEvents=null,i.removeEventListener("localcandidate",this.transceivers[n].bufferCandidates),i.onlocalcandidate=function(e){if(!(r.usingBundle&&n>0)){var o=new Event("icecandidate");o.candidate={sdpMid:t,sdpMLineIndex:n};var s=e.candidate,a=!s||0===Object.keys(s).length;if(a)"new"!==i.state&&"gathering"!==i.state||(i.state="completed");else{"new"===i.state&&(i.state="gathering"),s.component=1,s.ufrag=i.getLocalParameters().usernameFragment;var c=x.writeCandidate(s);o.candidate=Object.assign(o.candidate,x.parseCandidate(c)),o.candidate.candidate=c,o.candidate.toJSON=function(){return{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex,usernameFragment:o.candidate.usernameFragment}}}var d=x.getMediaSections(r._localDescription.sdp);d[o.candidate.sdpMLineIndex]+=a?"a=end-of-candidates\r\n":"a="+o.candidate.candidate+"\r\n",r._localDescription.sdp=x.getDescription(r._localDescription.sdp)+d.join("");var l=r.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==r.iceGatheringState&&(r.iceGatheringState="gathering",r._emitGatheringStateChange()),a||r._dispatchEvent("icecandidate",o),l&&(r._dispatchEvent("icecandidate",new Event("icecandidate")),r.iceGatheringState="complete",r._emitGatheringStateChange())}},e.setTimeout((function(){o.forEach((function(e){i.onlocalcandidate(e)}))}),0)}},i.prototype._createIceAndDtlsTransports=function(){var t=this,n=new e.RTCIceTransport(null);n.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var r=new e.RTCDtlsTransport(n);return r.ondtlsstatechange=function(){t._updateConnectionState()},r.onerror=function(){Object.defineProperty(r,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:n,dtlsTransport:r}},i.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var n=this.transceivers[e].iceTransport;n&&(delete n.onicestatechange,delete this.transceivers[e].iceTransport);var r=this.transceivers[e].dtlsTransport;r&&(delete r.ondtlsstatechange,delete r.onerror,delete this.transceivers[e].dtlsTransport)},i.prototype._transceive=function(e,n,r){var i=O(e.localCapabilities,e.remoteCapabilities);n&&e.rtpSender&&(i.encodings=e.sendEncodingParameters,i.rtcp={cname:x.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(i.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(i)),r&&e.rtpReceiver&&i.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?i.encodings=e.recvEncodingParameters:i.encodings=[{}],i.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(i.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(i.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(i))},i.prototype.setLocalDescription=function(e){var t,n,r=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(M("TypeError",'Unsupported type "'+e.type+'"'));if(!L("setLocalDescription",e.type,r.signalingState)||r._isClosed)return Promise.reject(M("InvalidStateError","Can not set local "+e.type+" in state "+r.signalingState));if("offer"===e.type)t=x.splitSections(e.sdp),n=t.shift(),t.forEach((function(e,t){var n=x.parseRtpParameters(e);r.transceivers[t].localCapabilities=n})),r.transceivers.forEach((function(e,t){r._gather(e.mid,t)}));else if("answer"===e.type){t=x.splitSections(r._remoteDescription.sdp),n=t.shift();var i=x.matchPrefix(n,"a=ice-lite").length>0;t.forEach((function(e,t){var o=r.transceivers[t],s=o.iceGatherer,a=o.iceTransport,c=o.dtlsTransport,d=o.localCapabilities,l=o.remoteCapabilities;if(!(x.isRejected(e)&&0===x.matchPrefix(e,"a=bundle-only").length)&&!o.rejected){var p=x.getIceParameters(e,n),u=x.getDtlsParameters(e,n);i&&(u.role="server"),r.usingBundle&&0!==t||(r._gather(o.mid,t),"new"===a.state&&a.start(s,p,i?"controlling":"controlled"),"new"===c.state&&c.start(u));var h=O(d,l);r._transceive(o,h.codecs.length>0,!1)}}))}return r._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?r._updateSignalingState("have-local-offer"):r._updateSignalingState("stable"),Promise.resolve()},i.prototype.setRemoteDescription=function(i){var o=this;if(-1===["offer","answer"].indexOf(i.type))return Promise.reject(M("TypeError",'Unsupported type "'+i.type+'"'));if(!L("setRemoteDescription",i.type,o.signalingState)||o._isClosed)return Promise.reject(M("InvalidStateError","Can not set remote "+i.type+" in state "+o.signalingState));var s={};o.remoteStreams.forEach((function(e){s[e.id]=e}));var a=[],c=x.splitSections(i.sdp),d=c.shift(),l=x.matchPrefix(d,"a=ice-lite").length>0,p=x.matchPrefix(d,"a=group:BUNDLE ").length>0;o.usingBundle=p;var u=x.matchPrefix(d,"a=ice-options:")[0];return o.canTrickleIceCandidates=!!u&&u.substr(14).split(" ").indexOf("trickle")>=0,c.forEach((function(r,c){var u=x.splitLines(r),h=x.getKind(r),f=x.isRejected(r)&&0===x.matchPrefix(r,"a=bundle-only").length,m=u[0].substr(2).split(" ")[2],v=x.getDirection(r,d),y=x.parseMsid(r),g=x.getMid(r)||x.generateIdentifier();if(f||"application"===h&&("DTLS/SCTP"===m||"UDP/DTLS/SCTP"===m))o.transceivers[c]={mid:g,kind:h,protocol:m,rejected:!0};else{var S,C,T,E,b,R,w,P,_;!f&&o.transceivers[c]&&o.transceivers[c].rejected&&(o.transceivers[c]=o._createTransceiver(h,!0));var k,D,I=x.parseRtpParameters(r);f||(k=x.getIceParameters(r,d),(D=x.getDtlsParameters(r,d)).role="client"),w=x.parseRtpEncodingParameters(r);var A=x.parseRtcpParameters(r),L=x.matchPrefix(r,"a=end-of-candidates",d).length>0,M=x.matchPrefix(r,"a=candidate:").map((function(e){return x.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===i.type||"answer"===i.type)&&!f&&p&&c>0&&o.transceivers[c]&&(o._disposeIceAndDtlsTransports(c),o.transceivers[c].iceGatherer=o.transceivers[0].iceGatherer,o.transceivers[c].iceTransport=o.transceivers[0].iceTransport,o.transceivers[c].dtlsTransport=o.transceivers[0].dtlsTransport,o.transceivers[c].rtpSender&&o.transceivers[c].rtpSender.setTransport(o.transceivers[0].dtlsTransport),o.transceivers[c].rtpReceiver&&o.transceivers[c].rtpReceiver.setTransport(o.transceivers[0].dtlsTransport)),"offer"!==i.type||f){if("answer"===i.type&&!f){C=(S=o.transceivers[c]).iceGatherer,T=S.iceTransport,E=S.dtlsTransport,b=S.rtpReceiver,R=S.sendEncodingParameters,P=S.localCapabilities,o.transceivers[c].recvEncodingParameters=w,o.transceivers[c].remoteCapabilities=I,o.transceivers[c].rtcpParameters=A,M.length&&"new"===T.state&&(!l&&!L||p&&0!==c?M.forEach((function(e){N(S.iceTransport,e)})):T.setRemoteCandidates(M)),p&&0!==c||("new"===T.state&&T.start(C,k,"controlling"),"new"===E.state&&E.start(D)),!O(S.localCapabilities,S.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&S.sendEncodingParameters[0].rtx&&delete S.sendEncodingParameters[0].rtx,o._transceive(S,"sendrecv"===v||"recvonly"===v,"sendrecv"===v||"sendonly"===v),!b||"sendrecv"!==v&&"sendonly"!==v?delete S.rtpReceiver:(_=b.track,y?(s[y.stream]||(s[y.stream]=new e.MediaStream),n(_,s[y.stream]),a.push([_,b,s[y.stream]])):(s.default||(s.default=new e.MediaStream),n(_,s.default),a.push([_,b,s.default])))}}else{(S=o.transceivers[c]||o._createTransceiver(h)).mid=g,S.iceGatherer||(S.iceGatherer=o._createIceGatherer(c,p)),M.length&&"new"===S.iceTransport.state&&(!L||p&&0!==c?M.forEach((function(e){N(S.iceTransport,e)})):S.iceTransport.setRemoteCandidates(M)),P=e.RTCRtpReceiver.getCapabilities(h),t<15019&&(P.codecs=P.codecs.filter((function(e){return"rtx"!==e.name}))),R=S.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var j,V=!1;if("sendrecv"===v||"sendonly"===v){if(V=!S.rtpReceiver,b=S.rtpReceiver||new e.RTCRtpReceiver(S.dtlsTransport,h),V)_=b.track,y&&"-"===y.stream||(y?(s[y.stream]||(s[y.stream]=new e.MediaStream,Object.defineProperty(s[y.stream],"id",{get:function(){return y.stream}})),Object.defineProperty(_,"id",{get:function(){return y.track}}),j=s[y.stream]):(s.default||(s.default=new e.MediaStream),j=s.default)),j&&(n(_,j),S.associatedRemoteMediaStreams.push(j)),a.push([_,b,j])}else S.rtpReceiver&&S.rtpReceiver.track&&(S.associatedRemoteMediaStreams.forEach((function(t){var n=t.getTracks().find((function(e){return e.id===S.rtpReceiver.track.id}));n&&function(t,n){n.removeTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(n,t)})),S.associatedRemoteMediaStreams=[]);S.localCapabilities=P,S.remoteCapabilities=I,S.rtpReceiver=b,S.rtcpParameters=A,S.sendEncodingParameters=R,S.recvEncodingParameters=w,o._transceive(o.transceivers[c],!1,V)}}})),void 0===o._dtlsRole&&(o._dtlsRole="offer"===i.type?"active":"passive"),o._remoteDescription={type:i.type,sdp:i.sdp},"offer"===i.type?o._updateSignalingState("have-remote-offer"):o._updateSignalingState("stable"),Object.keys(s).forEach((function(t){var n=s[t];if(n.getTracks().length){if(-1===o.remoteStreams.indexOf(n)){o.remoteStreams.push(n);var i=new Event("addstream");i.stream=n,e.setTimeout((function(){o._dispatchEvent("addstream",i)}))}a.forEach((function(e){var t=e[0],i=e[1];n.id===e[2].id&&r(o,t,i,[n])}))}})),a.forEach((function(e){e[2]||r(o,e[0],e[1],[])})),e.setTimeout((function(){o&&o.transceivers&&o.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},i.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},i.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},i.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},i.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var n=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",n)}},i.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var n=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",n)}},i.prototype.createOffer=function(){var n=this;if(n._isClosed)return Promise.reject(M("InvalidStateError","Can not call createOffer after close"));var r=n.transceivers.filter((function(e){return"audio"===e.kind})).length,i=n.transceivers.filter((function(e){return"video"===e.kind})).length,o=arguments[0];if(o){if(o.mandatory||o.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==o.offerToReceiveAudio&&(r=!0===o.offerToReceiveAudio?1:!1===o.offerToReceiveAudio?0:o.offerToReceiveAudio),void 0!==o.offerToReceiveVideo&&(i=!0===o.offerToReceiveVideo?1:!1===o.offerToReceiveVideo?0:o.offerToReceiveVideo)}for(n.transceivers.forEach((function(e){"audio"===e.kind?--r<0&&(e.wantReceive=!1):"video"===e.kind&&--i<0&&(e.wantReceive=!1)}));r>0||i>0;)r>0&&(n._createTransceiver("audio"),r--),i>0&&(n._createTransceiver("video"),i--);var s=x.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.transceivers.forEach((function(r,i){var o=r.track,s=r.kind,a=r.mid||x.generateIdentifier();r.mid=a,r.iceGatherer||(r.iceGatherer=n._createIceGatherer(i,n.usingBundle));var c=e.RTCRtpSender.getCapabilities(s);t<15019&&(c.codecs=c.codecs.filter((function(e){return"rtx"!==e.name}))),c.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),r.remoteCapabilities&&r.remoteCapabilities.codecs&&r.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),c.headerExtensions.forEach((function(e){(r.remoteCapabilities&&r.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var d=r.sendEncodingParameters||[{ssrc:1001*(2*i+1)}];o&&t>=15019&&"video"===s&&!d[0].rtx&&(d[0].rtx={ssrc:d[0].ssrc+1}),r.wantReceive&&(r.rtpReceiver=new e.RTCRtpReceiver(r.dtlsTransport,s)),r.localCapabilities=c,r.sendEncodingParameters=d})),"max-compat"!==n._config.bundlePolicy&&(s+="a=group:BUNDLE "+n.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),s+="a=ice-options:trickle\r\n",n.transceivers.forEach((function(e,t){s+=A(e,e.localCapabilities,"offer",e.stream,n._dtlsRole),s+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===n.iceGatheringState||0!==t&&n.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,s+="a="+x.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(s+="a=end-of-candidates\r\n"))}));var a=new e.RTCSessionDescription({type:"offer",sdp:s});return Promise.resolve(a)},i.prototype.createAnswer=function(){var n=this;if(n._isClosed)return Promise.reject(M("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==n.signalingState&&"have-local-pranswer"!==n.signalingState)return Promise.reject(M("InvalidStateError","Can not call createAnswer in signalingState "+n.signalingState));var r=x.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.usingBundle&&(r+="a=group:BUNDLE "+n.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),r+="a=ice-options:trickle\r\n";var i=x.getMediaSections(n._remoteDescription.sdp).length;n.transceivers.forEach((function(e,o){if(!(o+1>i)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?r+="m=application 0 DTLS/SCTP 5000\r\n":r+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?r+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(r+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(r+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var s;if(e.stream)"audio"===e.kind?s=e.stream.getAudioTracks()[0]:"video"===e.kind&&(s=e.stream.getVideoTracks()[0]),s&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var a=O(e.localCapabilities,e.remoteCapabilities);!a.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,r+=A(e,a,"answer",e.stream,n._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(r+="a=rtcp-rsize\r\n")}}));var o=new e.RTCSessionDescription({type:"answer",sdp:r});return Promise.resolve(o)},i.prototype.addIceCandidate=function(e){var t,n=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(r,i){if(!n._remoteDescription)return i(M("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var o=e.sdpMLineIndex;if(e.sdpMid)for(var s=0;s<n.transceivers.length;s++)if(n.transceivers[s].mid===e.sdpMid){o=s;break}var a=n.transceivers[o];if(!a)return i(M("OperationError","Can not add ICE candidate"));if(a.rejected)return r();var c=Object.keys(e.candidate).length>0?x.parseCandidate(e.candidate):{};if("tcp"===c.protocol&&(0===c.port||9===c.port))return r();if(c.component&&1!==c.component)return r();if((0===o||o>0&&a.iceTransport!==n.transceivers[0].iceTransport)&&!N(a.iceTransport,c))return i(M("OperationError","Can not add ICE candidate"));var d=e.candidate.trim();0===d.indexOf("a=")&&(d=d.substr(2)),(t=x.getMediaSections(n._remoteDescription.sdp))[o]+="a="+(c.type?d:"end-of-candidates")+"\r\n",n._remoteDescription.sdp=x.getDescription(n._remoteDescription.sdp)+t.join("")}else for(var l=0;l<n.transceivers.length&&(n.transceivers[l].rejected||(n.transceivers[l].iceTransport.addRemoteCandidate({}),(t=x.getMediaSections(n._remoteDescription.sdp))[l]+="a=end-of-candidates\r\n",n._remoteDescription.sdp=x.getDescription(n._remoteDescription.sdp)+t.join(""),!n.usingBundle));l++);r()}))},i.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var n=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?n=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(n=e.rtpReceiver)})),!n)throw M("InvalidAccessError","Invalid selector.");return n.getStats()}var r=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&r.push(e[t].getStats())}))})),Promise.all(r).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var n=e[t];if(n&&n.prototype&&n.prototype.getStats){var r=n.prototype.getStats;n.prototype.getStats=function(){return r.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(n){var r;e[n].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(r=e[n]).type]||r.type,t.set(n,e[n])})),t}))}}}));var o=["createOffer","createAnswer"];return o.forEach((function(e){var t=i.prototype[e];i.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(o=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=i.prototype[e];i.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=i.prototype[e];i.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),i};function V(e){const t=e&&e.navigator,n=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return n(e).catch((e=>Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e))))}}function U(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}function F(e,t){if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const n=new Event("enabled");n.enabled=e,this.dispatchEvent(n)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const n=j(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=function(e,t){let n=!1;return(e=JSON.parse(JSON.stringify(e))).filter((e=>{if(e&&(e.urls||e.url)){let t=e.urls||e.url;e.url&&!e.urls&&f("RTCIceServer.url","RTCIceServer.urls");const r="string"==typeof t;return r&&(t=[t]),t=t.filter((e=>{if(0===e.indexOf("stun:"))return!1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!n?(n=!0,!0):t&&!n})),delete e.url,e.urls=r?t[0]:t,!!t.length}}))}(e.iceServers,t.version),h("ICE servers after filtering:",e.iceServers)),new n(e)},e.RTCPeerConnection.prototype=n.prototype}function G(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}var B=Object.freeze({__proto__:null,shimPeerConnection:F,shimReplaceTrack:G,shimGetUserMedia:V,shimGetDisplayMedia:U});function W(e,t){const n=e&&e.navigator,r=e&&e.MediaStreamTrack;if(n.getUserMedia=function(e,t,r){f("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(e).then(t,r)},!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const e=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},t=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(n){return"object"==typeof n&&"object"==typeof n.audio&&(n=JSON.parse(JSON.stringify(n)),e(n.audio,"autoGainControl","mozAutoGainControl"),e(n.audio,"noiseSuppression","mozNoiseSuppression")),t(n)},r&&r.prototype.getSettings){const t=r.prototype.getSettings;r.prototype.getSettings=function(){const n=t.apply(this,arguments);return e(n,"mozAutoGainControl","autoGainControl"),e(n,"mozNoiseSuppression","noiseSuppression"),n}}if(r&&r.prototype.applyConstraints){const t=r.prototype.applyConstraints;r.prototype.applyConstraints=function(n){return"audio"===this.kind&&"object"==typeof n&&(n=JSON.parse(JSON.stringify(n)),e(n,"autoGainControl","mozAutoGainControl"),e(n,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[n])}}}}function z(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function X(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=r[t]}));const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,o]=arguments;return r.apply(this,[e||null]).then((e=>{if(t.version<53&&!i)try{e.forEach((e=>{e.type=n[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,r)=>{e.set(r,Object.assign({},t,{type:n[t.type]||t.type}))}))}return e})).then(i,o)}}function H(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function J(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),l(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Q(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){f("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function Z(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function q(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],n=e&&"sendEncodings"in e;n&&e.sendEncodings.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const r=t.apply(this,arguments);if(n){const{sender:t}=r,n=t.getParameters();(!("encodings"in n)||1===n.encodings.length&&0===Object.keys(n.encodings[0]).length)&&(n.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(n).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return r})}function K(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function Y(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function $(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var ee=Object.freeze({__proto__:null,shimOnTrack:z,shimPeerConnection:X,shimSenderGetStats:H,shimReceiverGetStats:J,shimRemoveStream:Q,shimRTCDataChannel:Z,shimAddTransceiver:q,shimGetParameters:K,shimCreateOffer:Y,shimCreateAnswer:$,shimGetUserMedia:W,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===n.video?n.video={mediaSource:t}:n.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(n)})}});function te(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((n=>t.call(this,n,e))),e.getVideoTracks().forEach((n=>t.call(this,n,e)))},e.RTCPeerConnection.prototype.addTrack=function(e,...n){return n&&n.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const n=e.getTracks();this.getSenders().forEach((e=>{n.includes(e.track)&&this.removeTrack(e)}))})}}function ne(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const n=new Event("addstream");n.stream=t,e.dispatchEvent(n)}))}),t.apply(e,arguments)}}}function re(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,n=t.createOffer,r=t.createAnswer,i=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){const r=arguments.length>=2?arguments[2]:arguments[0],i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i};let a=function(e,t,n){const r=i.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r};t.setLocalDescription=a,a=function(e,t,n){const r=o.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.setRemoteDescription=a,a=function(e,t,n){const r=s.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.addIceCandidate=a}function ie(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,n=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>n(oe(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,r){t.mediaDevices.getUserMedia(e).then(n,r)}.bind(t))}function oe(e){return e&&void 0!==e.video?Object.assign({},e,{video:v(e.video)}):e}function se(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){const t=[];for(let n=0;n<e.iceServers.length;n++){let r=e.iceServers[n];!r.hasOwnProperty("urls")&&r.hasOwnProperty("url")?(f("RTCIceServer.url","RTCIceServer.urls"),r=JSON.parse(JSON.stringify(r)),r.urls=r.url,delete r.url,t.push(r)):t.push(e.iceServers[n])}e.iceServers=t}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function ae(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ce(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const n=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveVideo||n||this.addTransceiver("video")}return t.apply(this,arguments)}}function de(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var le=Object.freeze({__proto__:null,shimLocalStreamsAPI:te,shimRemoteStreamsAPI:ne,shimCallbacksAPI:re,shimGetUserMedia:ie,shimConstraints:oe,shimRTCIceServerUrls:se,shimTrackEventTransceiver:ae,shimCreateOfferLegacy:ce,shimAudioContext:de});function pe(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const n=new t(e),r=x.parseCandidate(e.candidate),i=Object.assign(n,r);return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,l(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function ue(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const n=function(e){if(!e||!e.sdp)return!1;const t=x.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=x.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},r=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const n=parseInt(t[1],10);return n!=n?-1:n},i=function(e){let n=65536;return"firefox"===t.browser&&(n=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),n},o=function(e,n){let r=65536;"firefox"===t.browser&&57===t.version&&(r=65535);const i=x.matchPrefix(e.sdp,"a=max-message-size:");return i.length>0?r=parseInt(i[0].substr(19),10):"firefox"===t.browser&&-1!==n&&(r=2147483637),r},s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const e=r(arguments[0]),t=i(e),n=o(arguments[0],e);let s;s=0===t&&0===n?Number.POSITIVE_INFINITY:0===t||0===n?Math.max(t,n):Math.min(t,n);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>s}),this._sctp=a}return s.apply(this,arguments)}}function he(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const n=e.send;e.send=function(){const r=arguments[0],i=r.length||r.size||r.byteLength;if("open"===e.readyState&&t.sctp&&i>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return n.apply(e,arguments)}}const n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=n.apply(this,arguments);return t(e,this),e},l(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function fe(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const n=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const n=new Event("connectionstatechange",e);t.dispatchEvent(n)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}}))}function me(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const n=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:n}):t.sdp=n}return n.apply(this,arguments)}}function ve(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.addIceCandidate;n&&0!==n.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}var ye=Object.freeze({__proto__:null,shimRTCIceCandidate:pe,shimMaxMessageSize:ue,shimSendThrowTypeError:he,shimConnectionState:fe,removeExtmapAllowMixed:me,shimAddIceCandidateNullOrEmpty:ve});const ge=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const n=h,r=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:n}=e;if(n.mozGetUserMedia)t.browser="firefox",t.version=d(n.userAgent,/Firefox\/(\d+)\./,1);else if(n.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=d(n.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(n.mediaDevices&&n.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=d(n.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!n.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=d(n.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),i={browserDetails:r,commonShim:ye,extractVersion:d,disableLog:p,disableWarnings:u};switch(r.browser){case"chrome":if(!I||!k||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),i;if(null===r.version)return n("Chrome shim can not determine version, not shimming."),i;n("adapter.js shimming chrome."),i.browserShim=I,ve(e,r),C(e,r),T(e),k(e,r),E(e),_(e,r),b(e),R(e),w(e),D(e,r),pe(e),fe(e),ue(e,r),he(e),me(e,r);break;case"firefox":if(!ee||!X||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),i;n("adapter.js shimming firefox."),i.browserShim=ee,ve(e,r),W(e,r),X(e,r),z(e),Q(e),H(e),J(e),Z(e),q(e),K(e),Y(e),$(e),pe(e),fe(e),ue(e,r),he(e);break;case"edge":if(!B||!F||!t.shimEdge)return n("MS edge shim is not included in this adapter release."),i;n("adapter.js shimming edge."),i.browserShim=B,V(e),U(e),F(e,r),G(e),ue(e,r),he(e);break;case"safari":if(!le||!t.shimSafari)return n("Safari shim is not included in this adapter release."),i;n("adapter.js shimming safari."),i.browserShim=le,ve(e,r),se(e),ce(e),re(e),te(e),ne(e),ae(e),ie(e),de(e),pe(e),ue(e,r),he(e),me(e,r);break;default:n("Unsupported browser!")}return i}({window:"undefined"==typeof window?void 0:window});var Se,Ce,Te,Ee,be,Re={"120p":{width:160,height:120,frameRate:15,bitrate:200},"180p":{width:320,height:180,frameRate:15,bitrate:350},"240p":{width:320,height:240,frameRate:15,bitrate:400},"360p":{width:640,height:360,frameRate:15,bitrate:800},"480p":{width:640,height:480,frameRate:15,bitrate:900},"720p":{width:1280,height:720,frameRate:15,bitrate:1500},"1080p":{width:1920,height:1080,frameRate:15,bitrate:2e3},"2K":{width:2560,height:1440,frameRate:30,bitrate:4860},"4K":{width:3840,height:2160,frameRate:30,bitrate:9e3}},we={standard:{sampleRate:48e3,bitrate:40},high:{sampleRate:48e3,bitrate:128}};!function(e){e[e.DISCONNECTED=0]="DISCONNECTED",e[e.CONNECTING=1]="CONNECTING",e[e.ESTABLISHED=2]="ESTABLISHED",e[e.RECONNECTING=3]="RECONNECTING"}(Se||(Se={})),function(e){e[e.FAILURE=-1]="FAILURE",e[e.SUCCESS=0]="SUCCESS"}(Ce||(Ce={})),function(e){e[e.NEED_RECONNECT=-1]="NEED_RECONNECT",e[e.MANUAL_CLOSE=0]="MANUAL_CLOSE"}(Te||(Te={})),function(e){e[e.SEND=0]="SEND",e[e.RECEIVE=1]="RECEIVE"}(Ee||(Ee={})),function(e){e[e.TXLIVE_ERROR_WEBRTC_FAILED=-1]="TXLIVE_ERROR_WEBRTC_FAILED",e[e.TXLIVE_ERROR_REQUEST_FAILED=-2]="TXLIVE_ERROR_REQUEST_FAILED",e[e.TXLIVE_WARNING_CAMERA_START_FAILED=-1001]="TXLIVE_WARNING_CAMERA_START_FAILED",e[e.TXLIVE_WARNING_MICROPHONE_START_FAILED=-1002]="TXLIVE_WARNING_MICROPHONE_START_FAILED",e[e.TXLIVE_WARNING_SCREEN_CAPTURE_START_FAILED=-1003]="TXLIVE_WARNING_SCREEN_CAPTURE_START_FAILED",e[e.TXLIVE_WARNING_MEDIA_FILE_START_FAILED=-1004]="TXLIVE_WARNING_MEDIA_FILE_START_FAILED",e[e.TXLIVE_WARNING_CAMERA_INTERRUPTED=-1005]="TXLIVE_WARNING_CAMERA_INTERRUPTED",e[e.TXLIVE_WARNING_MICROPHONE_INTERRUPTED=-1006]="TXLIVE_WARNING_MICROPHONE_INTERRUPTED",e[e.TXLIVE_WARNING_SCREEN_CAPTURE_INTERRUPTED=-1007]="TXLIVE_WARNING_SCREEN_CAPTURE_INTERRUPTED"}(be||(be={}));var Pe="https://webrtcpush.myqcloud.com/webrtc/v1",_e=function(e,t){return fetch(e,{body:JSON.stringify(t),cache:"no-cache",credentials:"same-origin",headers:{"content-type":"application/json"},method:"POST",mode:"cors"}).then((function(e){return e.json()}))},ke=function(e){return r(void 0,void 0,void 0,(function(){var t,n,r;return i(this,(function(i){switch(i.label){case 0:return Pe+"/stopstream",[4,_e("https://webrtcpush.myqcloud.com/webrtc/v1/stopstream",e)];case 1:if(t=i.sent(),n=t.errcode,r=t.errmsg,0!==n)throw new Error("stop stream failed, errCode:"+n+", errmsg:"+r);return[2,t]}}))}))};/firefox\/(\d+)\./i.test(navigator.userAgent);var De=/safari\/(\d+)\./i.test(navigator.userAgent)&&!/chrome\/(\d+)\./i.test(navigator.userAgent),Ie=function(){var e,t;return!(!(null===(e=navigator.mediaDevices)||void 0===e?void 0:e.enumerateDevices)||!(null===(t=navigator.mediaDevices)||void 0===t?void 0:t.getUserMedia))},xe=function(){var e;return!!(null===(e=navigator.mediaDevices)||void 0===e?void 0:e.getDisplayMedia)},Ae=function(e){var t=/^(?:webrtc:\/\/)(?:[0-9.\-A-Za-z_]+)(?:\/)(?:[0-9.\-A-Za-z_]+)(?:\/)([^?#]*)(?:\?*)(?:[^?#]*)/.exec(e);return t?t[1]:null},Oe=function(){for(var e=[],t="0123456789abcdef",n=0;n<36;n++)e[n]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]="",e[13]="",e[18]="",e[23]="",e.join("")},Le=function(){function e(){this.peerConnection=null,this.clientSideDescription=null,this.connectStatus=Se.DISCONNECTED,this.connectDirection=Ee.RECEIVE,this.negotiating=!1,this.intervalId=null,this.bandwidthRestriction={video:null,audio:null},this.onAddTrack=null,this.onConnect=null,this.onDisconnect=null,this.onSetLocalDescription=null,this.onError=null,this.onStats=null,this.onTrack=this.onTrack.bind(this),this.onIceConnectionStateChange=this.onIceConnectionStateChange.bind(this),this.onIceCandidate=this.onIceCandidate.bind(this),this.onSignalingStateChange=this.onSignalingStateChange.bind(this),this.onConnectionStateChange=this.onConnectionStateChange.bind(this),this.onNegotiationNeeded=this.onNegotiationNeeded.bind(this)}return e.prototype.init=function(e){var t=void 0===e?{}:e,n=t.onAddTrack,r=void 0===n?null:n,i=t.onConnect,o=void 0===i?null:i,s=t.onDisconnect,a=void 0===s?null:s,c=t.onSetLocalDescription,d=void 0===c?null:c,l=t.onError,p=void 0===l?null:l,u=t.onStats,h=void 0===u?null:u;this.onAddTrack=r,this.onConnect=o,this.onDisconnect=a,this.onSetLocalDescription=d,this.onError=p,this.onStats=h},e.prototype.initWebRTCConnect=function(e){var t=void 0===e?{}:e,n=t.config,o=void 0===n?{}:n,s=t.direction,a=void 0===s?Ee.RECEIVE:s,c=t.stream;return r(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return console.log("CloudWebRTC init"),this.peerConnection?(console.log("Call disconnected before connect"),[2]):(this.connectDirection=a,[4,this.createWebRTCConnect(o,c)]);case 1:return e.sent(),[2]}}))}))},e.prototype.connect=function(e){console.log("connection connect->",e),e&&this.onAnswer(e)},e.prototype.disconnect=function(e){var t,n=void 0===e?{}:e,r=n.msg,i=void 0===r?"":r,o=n.code,s=void 0===o?Te.MANUAL_CLOSE:o;console.log("connection disconnect->",s,i),this.connectStatus!==Se.DISCONNECTED&&(this.connectStatus=Se.DISCONNECTED,this.negotiating=!1,this.intervalId&&window.clearInterval(this.intervalId),this.peerConnection&&(this.peerConnection.removeEventListener("track",this.onTrack),this.peerConnection.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.peerConnection.removeEventListener("icecandidate",this.onIceCandidate),this.peerConnection.removeEventListener("signalingstatechange",this.onSignalingStateChange),this.peerConnection.removeEventListener("connectionstatechange",this.onConnectionStateChange),this.peerConnection.removeEventListener("negotiationneeded",this.onNegotiationNeeded),this.peerConnection.close(),this.peerConnection=null),this.clientSideDescription=null,s===Te.NEED_RECONNECT&&console.log("Please try to reconnect"),null===(t=this.onDisconnect)||void 0===t||t.call(this,{code:s,msg:i}))},e.prototype.getClientSideDescription=function(){return this.clientSideDescription||console.error("webrtc is not initialized"),this.clientSideDescription},e.prototype.getConnectStatus=function(){return this.connectStatus},e.prototype.setBandwidth=function(e,t){return r(this,void 0,void 0,(function(){var n,r,o,s,a,c,d,l,p,u,h;return i(this,(function(i){switch(i.label){case 0:if(this.bandwidthRestriction[e]=t,this.connectStatus!==Se.ESTABLISHED)return[2];if(this.connectDirection===Ee.RECEIVE)return[2];if(n=ge.browserDetails,r=n.browser,o=n.version,!(("chrome"===r||"safari"===r||"firefox"===r&&o>=64)&&"RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype))return[3,5];if(!(s=this.peerConnection.getSenders().find((function(t){return t.track&&t.track.kind===e}))))return[3,4];(a=s.getParameters()).encodings&&0!==a.encodings.length||(a.encodings=[{}]),a.encodings[0].maxBitrate=1e3*t,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,s.setParameters(a)];case 2:return i.sent(),console.log(e+" bandwidth is set to "+t+" kbps"),[3,4];case 3:return c=i.sent(),console.log("failed to set bandwidth by setting maxBitrate:",c),[3,4];case 4:return[2];case 5:return i.trys.push([5,9,,10]),[4,this.peerConnection.createOffer()];case 6:return(d=i.sent()).sdp=this.updateOpusRestriction(d.sdp),[4,this.peerConnection.setLocalDescription(d)];case 7:return i.sent(),this.clientSideDescription=this.peerConnection.localDescription,l=this.peerConnection.remoteDescription,p=l.type,u=l.sdp,h={type:p,sdp:this.updateBandwidthRestriction(e,t,u)},console.log("applying bandwidth restriction to setRemoteDescription"),[4,this.peerConnection.setRemoteDescription(h)];case 8:return i.sent(),[3,10];case 9:return i.sent(),console.log("failed to setRemoteDescription with bandwidth restriction"),[3,10];case 10:return[2]}}))}))},e.prototype.replaceTrack=function(e){return r(this,void 0,void 0,(function(){var t;return i(this,(function(n){switch(n.label){case 0:if(this.connectDirection===Ee.RECEIVE)return[2];if(this.connectStatus!==Se.ESTABLISHED)return[2];n.label=1;case 1:return n.trys.push([1,4,,5]),(t=this.peerConnection.getSenders().find((function(t){return t.track&&t.track.kind===e.kind})))?[4,t.replaceTrack(e)]:[3,3];case 2:n.sent(),n.label=3;case 3:return[3,5];case 4:return n.sent(),console.log("sender replaceTrack failed"),[3,5];case 5:return[2]}}))}))},e.prototype.createWebRTCConnect=function(e,t){var o;return void 0===e&&(e={}),r(this,void 0,void 0,(function(){var r,s=this;return i(this,(function(i){switch(i.label){case 0:try{r=n({iceServers:[],sdpSemantics:"unified-plan",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",tcpCandidatePolicy:"disable",IceTransportsType:"nohost"},e),this.peerConnection=new RTCPeerConnection(r)}catch(e){return console.log(e),"ReferenceError"===e.name&&e.message.includes("RTCPeerConnection")&&(console.log("Not support WebRTC"),null===(o=this.onError)||void 0===o||o.call(this,"WebRTC is not supported")),[2]}return this.connectStatus=Se.CONNECTING,this.negotiating=!1,this.peerConnection.addEventListener("track",this.onTrack),this.peerConnection.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.peerConnection.addEventListener("icecandidate",this.onIceCandidate),this.peerConnection.addEventListener("signalingstatechange",this.onSignalingStateChange),this.peerConnection.addEventListener("connectionstatechange",this.onConnectionStateChange),this.peerConnection.addEventListener("negotiationneeded",this.onNegotiationNeeded),this.connectDirection===Ee.SEND&&t instanceof MediaStream&&t.getTracks().forEach((function(e){s.peerConnection.addTrack(e,t)})),this.connectDirection!==Ee.RECEIVE?[3,2]:[4,this.createOffer()];case 1:i.sent(),i.label=2;case 2:return[2]}}))}))},e.prototype.onTrack=function(e){var t;console.log("onTrack",e),console.log("on "+e.track.kind+" track",e.streams,e.track),null===(t=this.onAddTrack)||void 0===t||t.call(this,e.track)},e.prototype.onIceConnectionStateChange=function(e){switch(console.log("onIceConnectionStateChange",this.peerConnection.iceConnectionState,e),this.peerConnection.iceConnectionState){case"failed":case"disconnected":console.log("Connection disconnected, please try again"),this.disconnect({code:Te.NEED_RECONNECT,msg:"Connection disconnected, please try again"})}},e.prototype.onIceCandidate=function(e){console.log("onIceCandidate",e)},e.prototype.onSignalingStateChange=function(e){console.log("onSignalingStateChange",this.peerConnection.signalingState,e)},e.prototype.onConnectionStateChange=function(e){var t;switch(console.log("onConnectionStateChange",this.peerConnection.connectionState,e),this.peerConnection.connectionState){case"failed":case"disconnected":console.log("Connection disconnected, please try again"),this.disconnect({code:Te.NEED_RECONNECT,msg:"Connection disconnected, please try again"});break;case"connected":console.log("Connection connected"),this.connectStatus=Se.ESTABLISHED,this.bandwidthRestriction.video&&this.setBandwidth("video",this.bandwidthRestriction.video),this.bandwidthRestriction.audio&&this.setBandwidth("audio",this.bandwidthRestriction.audio),null===(t=this.onConnect)||void 0===t||t.call(this,{code:Ce.SUCCESS,msg:"Connection connected"}),this.startStatReport()}},e.prototype.onNegotiationNeeded=function(e){if(console.log("onNegotiationNeeded",e),this.connectDirection!==Ee.RECEIVE)try{if(this.negotiating||"stable"!==this.peerConnection.signalingState)return;this.negotiating=!0,this.createOffer()}catch(e){console.log("onNegotiationNeeded error",e)}finally{this.negotiating=!1}},e.prototype.createOffer=function(){var e;return r(this,void 0,void 0,(function(){var t,n,r,o;return i(this,(function(i){switch(i.label){case 0:t={},this.connectDirection===Ee.RECEIVE&&(n=!!this.peerConnection.addTransceiver,console.log("peerConnection "+(n?"":"no")+" addTransceiver"),n?(this.peerConnection.addTransceiver("audio",{direction:"recvonly"}),this.peerConnection.addTransceiver("video",{direction:"recvonly"})):t={offerToReceiveVideo:!0,offerToReceiveAudio:!0}),i.label=1;case 1:return i.trys.push([1,4,,5]),r=this.onOffer,[4,this.peerConnection.createOffer(t)];case 2:return[4,r.apply(this,[i.sent()])];case 3:return i.sent(),[3,5];case 4:return o=i.sent(),console.log("create offer error",o),this.disconnect({code:Te.NEED_RECONNECT,msg:"create offer is failed"}),null===(e=this.onError)||void 0===e||e.call(this,"create offer is failed"),[3,5];case 5:return[2]}}))}))},e.prototype.onOffer=function(e){var t,n;return r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:e.sdp=this.updateOpusRestriction(e.sdp),console.log("onOffer modify->",e),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.peerConnection.setLocalDescription(e)];case 2:return i.sent(),this.clientSideDescription=this.peerConnection.localDescription,null===(t=this.onSetLocalDescription)||void 0===t||t.call(this,this.clientSideDescription),[3,4];case 3:return r=i.sent(),console.log("setLocalDescription error",r,this.clientSideDescription),null===(n=this.onError)||void 0===n||n.call(this,"set local sdp is failed"),[3,4];case 4:return[2]}}))}))},e.prototype.onAnswer=function(e){var t;return r(this,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:console.log("onAnswer->",e),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.peerConnection.setRemoteDescription(new RTCSessionDescription(e))];case 2:return r.sent(),console.log("remoteDescription",this.peerConnection.remoteDescription),[3,4];case 3:return n=r.sent(),console.log("setRemoteDescription error",n,e),null===(t=this.onError)||void 0===t||t.call(this,"set remote sdp is failed"),[3,4];case 4:return[2]}}))}))},e.prototype.startStatReport=function(){var e=this;this.intervalId&&(window.clearInterval(this.intervalId),this.intervalId=null),this.intervalId=window.setInterval((function(){return r(e,void 0,void 0,(function(){var e,t;return i(this,(function(n){switch(n.label){case 0:return this.peerConnection?[4,this.peerConnection.getStats(null)]:[2];case 1:return e=n.sent(),null===(t=this.onStats)||void 0===t||t.call(this,e),[2]}}))}))}),1e3)},e.prototype.updateOpusRestriction=function(e){return e.split("\r\n").map((function(e){return e.includes("a=fmtp:111")?e+";stereo=1":e})).join("\r\n")},e.prototype.updateBandwidthRestriction=function(e,t,n){var r="AS";"firefox"===ge.browserDetails.browser&&(t*=1e3,r="TIAS");var i=new RegExp("m="+e+" (.*)\r\nc=IN (.*)\r\nb="+r+":(.*)\r\n"),o=new RegExp("m="+e+" (.*)\r\nc=IN (.*)\r\n"),s="m="+e+" $1\r\nc=IN $2\r\nb="+r+":"+t+"\r\n";return n=i.test(n)?n.replace(i,s):n.replace(o,s)},e}(),Ne=function(){function e(){this.mediaStream=null,this.onAddStream=null,this.onStopStream=null,this.onError=null,this.onSwitchStream=null}return e.prototype.init=function(e){var t=void 0===e?{}:e,n=t.onAddStream,r=void 0===n?null:n,i=t.onStopStream,o=void 0===i?null:i,s=t.onError,a=void 0===s?null:s,c=t.onSwitchStream,d=void 0===c?null:c;this.onAddStream=r,this.onStopStream=o,this.onError=a,this.onSwitchStream=d},e.prototype.addStreamStopListener=function(e,t){var n=t;e.addEventListener("ended",(function(){console.log("ended stream"),null==n||n(),n=null}),!1),e.getTracks().forEach((function(e){e.addEventListener("ended",(function(){console.log("ended stream track"),null==n||n(),n=null}),!1)}))},e}(),Me=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return t(n,e),n.prototype.startStream=function(e){var t,n,o=e.deviceId,s=e.frameRate,a=e.resolution;return r(this,void 0,void 0,(function(){var e,r,c,d,l=this;return i(this,(function(i){switch(i.label){case 0:if(this.mediaStream)return console.log("please stop camera stream first"),[2];e={frameRate:{ideal:s}},o&&(e.deviceId={exact:o}),a&&(e.width={ideal:a.width},e.height={ideal:a.height}),i.label=1;case 1:return i.trys.push([1,3,,4]),r=this,[4,navigator.mediaDevices.getUserMedia({video:e})];case 2:return r.mediaStream=i.sent(),this.addStreamStopListener(this.mediaStream,(function(){l.stopStream("interrupted")})),null===(t=this.onAddStream)||void 0===t||t.call(this,this.mediaStream,"camera"),[3,4];case 3:switch(c=i.sent(),console.log("start camera stream error,",c),d="",c.name){case"NotFoundError":case"DevicesNotFoundError":d="NotFoundError";break;case"NotAllowedError":case"PermissionDeniedError":d="NotAllowedError";break;default:d=c.name}return null===(n=this.onError)||void 0===n||n.call(this,d,"camera"),[3,4];case 4:return[2]}}))}))},n.prototype.stopStream=function(e){var t;void 0===e&&(e=""),this.mediaStream?(this.mediaStream.getTracks().forEach((function(e){e.stop()})),this.mediaStream=null,null===(t=this.onStopStream)||void 0===t||t.call(this,"camera",e)):console.log("camera stream is not existed")},n.prototype.switchStream=function(e){var t,n,o=e.deviceId,s=e.frameRate,a=e.resolution;return r(this,void 0,void 0,(function(){var e,r,c,d,l=this;return i(this,(function(i){switch(i.label){case 0:e={frameRate:{ideal:s}},o&&(e.deviceId={exact:o}),a&&(e.width={ideal:a.width},e.height={ideal:a.height}),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,navigator.mediaDevices.getUserMedia({video:e})];case 2:return r=i.sent(),this.addStreamStopListener(r,(function(){l.stopStream("interrupted")})),this.mediaStream=r,null===(t=this.onSwitchStream)||void 0===t||t.call(this,r,"camera"),[3,4];case 3:switch(c=i.sent(),console.log("switch camera stream error,",c),d="",c.name){case"NotFoundError":case"DevicesNotFoundError":d="NotFoundError";break;case"NotAllowedError":case"PermissionDeniedError":d="NotAllowedError";break;default:d=c.name}return null===(n=this.onError)||void 0===n||n.call(this,d,"camera"),[3,4];case 4:return[2]}}))}))},n}(Ne),je=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return t(n,e),n.prototype.startStream=function(e){var t,n,o=e.deviceId,s=e.sampleRate,a=e.echoCancellation,c=e.noiseSuppression,d=e.autoGainControl;return r(this,void 0,void 0,(function(){var e,r,l,p,u=this;return i(this,(function(i){switch(i.label){case 0:if(this.mediaStream)return console.log("please stop microphone stream first"),[2];e={sampleRate:s,echoCancellation:a,noiseSuppression:c,autoGainControl:d},o&&(e.deviceId={exact:o}),i.label=1;case 1:return i.trys.push([1,3,,4]),r=this,[4,navigator.mediaDevices.getUserMedia({audio:e})];case 2:return r.mediaStream=i.sent(),this.addStreamStopListener(this.mediaStream,(function(){u.stopStream("interrupted")})),null===(t=this.onAddStream)||void 0===t||t.call(this,this.mediaStream,"microphone"),[3,4];case 3:switch(l=i.sent(),console.log("start microphone stream error,",l),p="",l.name){case"NotFoundError":case"DevicesNotFoundError":p="NotFoundError";break;case"NotAllowedError":case"PermissionDeniedError":p="NotAllowedError";break;default:p=l.name}return null===(n=this.onError)||void 0===n||n.call(this,p,"microphone"),[3,4];case 4:return[2]}}))}))},n.prototype.stopStream=function(e){var t;void 0===e&&(e=""),this.mediaStream?(this.mediaStream.getTracks().forEach((function(e){e.stop()})),this.mediaStream=null,null===(t=this.onStopStream)||void 0===t||t.call(this,"microphone",e)):console.log("microphone stream is not existed")},n.prototype.switchStream=function(e){var t,n,o=e.deviceId,s=e.sampleRate,a=e.echoCancellation,c=e.noiseSuppression,d=e.autoGainControl;return r(this,void 0,void 0,(function(){var e,r,l,p,u=this;return i(this,(function(i){switch(i.label){case 0:e={sampleRate:s,echoCancellation:a,noiseSuppression:c,autoGainControl:d},o&&(e.deviceId={exact:o}),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,navigator.mediaDevices.getUserMedia({audio:e})];case 2:return r=i.sent(),this.addStreamStopListener(r,(function(){u.stopStream("interrupted")})),this.mediaStream=r,null===(t=this.onSwitchStream)||void 0===t||t.call(this,r,"microphone"),[3,4];case 3:switch(l=i.sent(),console.log("switch microphone stream error,",l),p="",l.name){case"NotFoundError":case"DevicesNotFoundError":p="NotFoundError";break;case"NotAllowedError":case"PermissionDeniedError":p="NotAllowedError";break;default:p=l.name}return null===(n=this.onError)||void 0===n||n.call(this,p,"microphone"),[3,4];case 4:return[2]}}))}))},n}(Ne),Ve=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return t(n,e),n.prototype.startStream=function(e){var t,n,o=e.frameRate,s=e.resolution;return r(this,void 0,void 0,(function(){var e,r,a,c=this;return i(this,(function(i){switch(i.label){case 0:if(this.mediaStream)return console.log("please stop screenCapture stream first"),[2];e={frameRate:{ideal:o}},s&&(e.width={ideal:s.width},e.height={ideal:s.height}),i.label=1;case 1:return i.trys.push([1,3,,4]),r=this,[4,navigator.mediaDevices.getDisplayMedia({video:e})];case 2:return r.mediaStream=i.sent(),this.addStreamStopListener(this.mediaStream,(function(){c.stopStream("interrupted")})),null===(t=this.onAddStream)||void 0===t||t.call(this,this.mediaStream,"screen"),[3,4];case 3:return a=i.sent(),console.log("start screenCapture stream error,",a),null===(n=this.onError)||void 0===n||n.call(this,a.name,"screen"),[3,4];case 4:return[2]}}))}))},n.prototype.stopStream=function(e){var t;void 0===e&&(e=""),this.mediaStream?(this.mediaStream.getTracks().forEach((function(e){e.stop()})),this.mediaStream=null,null===(t=this.onStopStream)||void 0===t||t.call(this,"screen",e)):console.log("screenCapture stream is not existed")},n}(Ne);function Ue(e,t,n){var r=void 0===t?null:t,i=function(e,t){var n=atob(e);if(t){for(var r=new Uint8Array(n.length),i=0,o=n.length;i<o;++i)r[i]=n.charCodeAt(i);return String.fromCharCode.apply(null,new Uint16Array(r.buffer))}return n}(e,void 0!==n&&n),o=i.indexOf("\n",10)+1,s=i.substring(o)+(r?"//# sourceMappingURL="+r:""),a=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(a)}var Fe,Ge,Be,We,ze=(Fe="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwp2YXIgd29ya2VyX2NvZGU9ZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7dmFyIGU9ITEsdD1udWxsO3NlbGYuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsKGZ1bmN0aW9uKHMpe3ZhciBhPXMuZGF0YSxyPWEudHlwZSxjPWEuZGF0YTtzd2l0Y2gocil7Y2FzZSJzdGFydCI6ZXx8KGU9ITAsdD1zZXRUaW1lb3V0KChmdW5jdGlvbigpe2U9ITEsc2VsZi5wb3N0TWVzc2FnZSgidGljayIpfSksYy50aW1lKSk7YnJlYWs7Y2FzZSJzdG9wIjpjbGVhclRpbWVvdXQodCksZT0hMX19KSwhMSk7cmV0dXJue319KCk7Cgo=",Ge=null,Be=!1,function(e){return We=We||Ue(Fe,Ge,Be),new Worker(We,e)}),Xe=function(e){function n(){var t=e.call(this)||this;return t.inputEl=null,t.canvasEl=null,t.videoUrl=null,t.isPlaying=!1,t.config=null,t.audioContext=window.TXLiveAudioContext,t.audioSource=null,t.videoStream=null,t.audioStream=null,t.worker=null,t.worker=new ze,t.onChange=t.onChange.bind(t),t.onCanPlay=t.onCanPlay.bind(t),t.onVideoError=t.onVideoError.bind(t),t.renderCanvasPlay=t.renderCanvasPlay.bind(t),t}return t(n,e),n.prototype.startStream=function(e){var t;return r(this,void 0,void 0,(function(){var n,r,o;return i(this,(function(i){return this.videoStream?(console.log("Please stop local file stream first"),[2]):(this.config=e,this.canvasEl||(n=e.playerView,(r=document.createElement("canvas")).style.display="none",this.canvasEl=r,null===(t=n.parentElement)||void 0===t||t.insertBefore(r,n.nextElementSibling)),this.canvasEl.width=e.resolution.width,this.canvasEl.height=e.resolution.height,e.file?this.playVideo(URL.createObjectURL(e.file)):(this.inputEl||((o=document.createElement("input")).type="file",o.accept="video/mp4",o.addEventListener("change",this.onChange),this.inputEl=o),this.inputEl.click()),[2])}))}))},n.prototype.stopStream=function(){var e;this.videoStream?(this.destroy(),this.audioSource&&this.audioSource.disconnect(),[this.videoStream,this.audioStream].forEach((function(e){e&&e.getTracks().forEach((function(e){e.stop()}))})),this.videoStream=null,this.audioStream=null,null===(e=this.onStopStream)||void 0===e||e.call(this,"file")):console.log("local file stream is not existed")},n.prototype.onChange=function(e){var t,n=e.target,r=null===(t=null==n?void 0:n.files)||void 0===t?void 0:t[0];r&&(this.playVideo(URL.createObjectURL(r)),n.value="")},n.prototype.onCanPlay=function(){this.isPlaying||this.startCanvasPlay()},n.prototype.onVideoError=function(e,t){var n;if(this.videoStream)this.stopStream();else{var r=this.config.playerView;this.destroy();var i="AbortError";r.error&&3===r.error.code&&(i="DecodeError"),null===(n=this.onError)||void 0===n||n.call(this,t||i,"file")}},n.prototype.renderCanvasPlay=function(){if(this.canvasEl){var e=this.config,t=e.playerView,n=e.frameRate,r=e.resolution,i=this.canvasEl.getContext("2d"),o=r.width,s=r.height,a=t.videoWidth,c=t.videoHeight,d=null,l=null;o/s<a/c?(d=o,l=o*c/a):(d=s*a/c,l=s),this.canvasEl.width=d,this.canvasEl.height=l,null==i||i.clearRect(0,0,d,l),null==i||i.drawImage(t,0,0,a,c,0,0,d,l),this.worker.postMessage({type:"start",data:{time:1e3/n}})}else console.log("canvas destroy, setTimeout stop.")},n.prototype.startCanvasPlay=function(){var e,t;if(this.canvasEl){var n=this.config,r=n.playerView,i=n.frameRate;this.worker.addEventListener("message",this.renderCanvasPlay),this.renderCanvasPlay(),console.log("start canvas play video");try{this.videoStream=this.canvasEl.captureStream(i),null===(e=this.onAddStream)||void 0===e||e.call(this,this.videoStream,"file")}catch(e){return console.log("start local file stream error,",e),void this.onVideoError(null,"NotSupported")}try{this.audioSource||(this.audioSource=this.audioContext.createMediaElementSource(r)),this.audioSource.connect(this.audioContext.destination);var o=this.audioContext.createMediaStreamDestination();this.audioSource.connect(o),this.audioStream=o.stream,null===(t=this.onAddStream)||void 0===t||t.call(this,this.audioStream,"file")}catch(e){console.log("audioStream err:",e)}this.videoStream&&(this.isPlaying=!0)}},n.prototype.playVideo=function(e){return r(this,void 0,void 0,(function(){var t,n;return i(this,(function(r){switch(r.label){case 0:t=this.config.playerView,this.videoUrl=e,t.addEventListener("error",this.onVideoError),t.addEventListener("canplay",this.onCanPlay),t.autoplay=!0,t.loop=!0,t.playsInline=!0,t.src=e,t.load(),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,t.play()];case 2:return r.sent(),console.log("play ok"),[3,4];case 3:return n=r.sent(),console.log("play failed",n),[3,4];case 4:return[2]}}))}))},n.prototype.destroy=function(){var e,t=this.config.playerView;t.removeEventListener("error",this.onVideoError),t.removeEventListener("canplay",this.onCanPlay),this.worker&&this.worker.removeEventListener("message",this.renderCanvasPlay),this.canvasEl&&(null===(e=this.canvasEl.parentElement)||void 0===e||e.removeChild(this.canvasEl),this.canvasEl=null),t.pause(),t.src="",t.load(),this.isPlaying=!1,this.config=null,this.videoUrl&&(URL.revokeObjectURL(this.videoUrl),this.videoUrl=null)},n}(Ne),He=function(){function e(e){var t=e.onSwitchDevice;this.currentDeviceId={video:"",audio:""},this.onSwitchDevice=null,this.onSwitchDevice=t}return e.prototype.getDevicesList=function(e){return r(this,void 0,void 0,(function(){var t,n,r,o;return i(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,navigator.mediaDevices.enumerateDevices()];case 1:return t=i.sent(),n=[],r=[],t.forEach((function(e){var t=e.kind,i=e.deviceId,o=e.label;"videoinput"===t?n.push({type:"video",deviceId:i,deviceName:o}):"audioinput"===t&&r.push({type:"audio",deviceId:i,deviceName:o})})),e?"video"===e?[2,n]:"audio"===e?[2,r]:[2,[]]:[2,[].concat(n,r)];case 2:return o=i.sent(),console.log("navigator.mediaDevices.enumerateDevices error: ",o),[2,[]];case 3:return[2]}}))}))},e.prototype.setCurrentDevice=function(e,t){Object.keys(this.currentDeviceId).includes(e)&&(this.currentDeviceId[e]=t.toString())},e.prototype.getCurrentDevice=function(e){return r(this,void 0,void 0,(function(){var t,n,r,o=this;return i(this,(function(i){switch(i.label){case 0:return t={type:"",deviceId:"",deviceName:""},Object.keys(this.currentDeviceId).includes(e)&&this.currentDeviceId[e]?(t.type=e,t.deviceId=this.currentDeviceId[e],[4,this.getDevicesList(e)]):[3,2];case 1:return n=i.sent(),(r=n.find((function(t){return t.deviceId===o.currentDeviceId[e]})))&&(t.deviceName=r.deviceName),[2,t];case 2:return[2,null]}}))}))},e.prototype.getCurrentDeviceId=function(e){return Object.keys(this.currentDeviceId).includes(e)&&this.currentDeviceId[e]?this.currentDeviceId[e]:null},e.prototype.switchDevice=function(e,t){"audio"===e||"video"===e?t?this.onSwitchDevice(e,t):console.log("deviceId is empty"):console.log('type must be "audio" or "video"')},e.prototype.switchCamera=function(e){this.switchDevice("video",e)},e.prototype.switchMicrophone=function(e){this.switchDevice("audio",e)},e}(),Je=function(){function e(){this.videoQuality=n({},Re["720p"]),this.audioQuality=n(n({},we.standard),{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}),this.connectRetry={maxNum:3,curNum:0,delay:1},this.playerView=null,this.webrtcConnection=null,this.videoStream=null,this.audioStream=null,this.cameraStream=null,this.microphoneStream=null,this.screenStream=null,this.fileStream=null,this.pushUrl=null,this.isVideoPushing=!1,this.sessionId=null,this.videoStreamType=null,this.timeoutId=null,this.lastStatsReport=null,this.deviceManager=null,this.observer={onError:null,onWarning:null,onCaptureFirstAudioFrame:null,onCaptureFirstVideoFrame:null,onPushStatusUpdate:null,onStatisticsUpdate:null},this.onAddStream=this.onAddStream.bind(this),this.onStopStream=this.onStopStream.bind(this),this.onStreamError=this.onStreamError.bind(this),this.onSetLocalDescription=this.onSetLocalDescription.bind(this),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.onWebRTCError=this.onWebRTCError.bind(this),this.onStats=this.onStats.bind(this),this.onSwitchDevice=this.onSwitchDevice.bind(this),this.onSwitchStream=this.onSwitchStream.bind(this),this.deviceManager=new He({onSwitchDevice:this.onSwitchDevice})}return e.checkSupport=function(){return r(void 0,void 0,void 0,(function(){var e;return i(this,(function(t){switch(t.label){case 0:return e={isWebRTCSupported:!(!window.RTCPeerConnection&&!window.webkitRTCPeerConnection)},[4,new Promise((function(e){try{var t=new RTCPeerConnection({iceServers:[]}),n=function(){t.createOffer().then((function(r){var i=r.sdp.toLowerCase().includes("h264");t.removeEventListener("negotiationneeded",n),t.close(),e(i)}))};t.addEventListener("negotiationneeded",n);var r=document.createElement("canvas");r.getContext("2d");var i=r.captureStream(0);i.getTracks().forEach((function(e){t.addTrack(e,i)}))}catch(t){e(!1)}}))];case 1:return e.isH264EncodeSupported=t.sent(),[4,r(void 0,void 0,void 0,(function(){var e,t,n,r;return i(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),e=new RTCPeerConnection({iceServers:[],sdpSemantics:"unified-plan"}),t={},e.addTransceiver?(e.addTransceiver("audio",{direction:"recvonly"}),e.addTransceiver("video",{direction:"recvonly"})):t={offerToReceiveVideo:!0,offerToReceiveAudio:!0},[4,e.createOffer(t)];case 1:return n=i.sent(),r=n.sdp.toLowerCase().includes("h264"),e.close(),[2,r];case 2:return i.sent(),[2,!1];case 3:return[2]}}))}))];case 2:return[2,(e.isH264DecodeSupported=t.sent(),e.isMediaDevicesSupported=Ie(),e.isScreenCaptureSupported=xe(),e.isMediaFileSupported=!(!document.createElement("canvas").captureStream||!window.AudioContext&&!window.webkitAudioContext),e)]}}))}))},e.__init=function(){var e=function(){var t;console.log("create AudioContext"),document.body.removeEventListener("touchstart",e,!1),document.body.removeEventListener("touchend",e,!1),document.body.removeEventListener("mouseup",e,!1),document.body.removeEventListener("click",e,!1),window.TXLiveAudioContext=new(window.AudioContext||window.webkitAudioContext),(t=window.TXLiveAudioContext,new Promise((function(e,n){if(t&&t instanceof(window.AudioContext||window.webkitAudioContext))if("suspended"===t.state){var r=function(){t.resume().then((function(){document.body.removeEventListener("touchstart",r,!1),document.body.removeEventListener("touchend",r,!1),document.body.removeEventListener("mouseup",r,!1),document.body.removeEventListener("click",r,!1),e(!0)}),(function(e){n(e)}))};document.body.addEventListener("touchstart",r,!1),document.body.addEventListener("touchend",r,!1),document.body.addEventListener("mouseup",r,!1),document.body.addEventListener("click",r,!1)}else e(!1);else n("WebAudioTouchUnlock: You need to pass an instance of AudioContext to this method call")}))).then((function(){console.log("AudioContext is unlocked")}))};document.body.addEventListener("touchstart",e,!1),document.body.addEventListener("touchend",e,!1),document.body.addEventListener("mouseup",e,!1),document.body.addEventListener("click",e,!1);var t=ge.browserDetails,n=t.browser,r=t.version;console.log("browser is "+n+", version is "+r)},e.prototype.setRenderView=function(e){if(this.playerView)console.log("render view is existed");else{var t="string"==typeof e?document.getElementById(e):e;t&&t instanceof HTMLDivElement?this.playerView=this.createVideoEl(t):console.log("Require container element id or HTMLDivElement")}},e.prototype.setVideoQuality=function(e){Re[e]?this.videoQuality=n(n({},this.videoQuality),Re[e]):console.log(e+" is not existed")},e.prototype.setAudioQuality=function(e){we[e]?this.audioQuality=n(n({},this.audioQuality),we[e]):console.log(e+" is not existed")},e.prototype.setProperty=function(e,t){var n,r;switch(e){case"setVideoResolution":"object"==typeof t&&"number"==typeof t.width&&"number"==typeof t.height&&t.width>0&&t.height>0?(this.videoQuality.width=t.width,this.videoQuality.height=t.height):console.log("videoResolution width and height must be a number greater than 0");break;case"setVideoFPS":"number"==typeof t&&t>0?this.videoQuality.frameRate=t:console.log("videoFPS must be a number greater than 0");break;case"setVideoBitrate":"number"==typeof t&&t>0?(this.videoQuality.bitrate=t,null===(n=this.webrtcConnection)||void 0===n||n.setBandwidth("video",t)):console.log("videoBitrate must be a number greater than 0");break;case"setAudioSampleRate":"number"==typeof t&&t>0?this.audioQuality.sampleRate=t:console.log("audioSampleRate must be a number greater than 0");break;case"setAudioBitrate":"number"==typeof t&&t>0?(this.audioQuality.bitrate=t,null===(r=this.webrtcConnection)||void 0===r||r.setBandwidth("audio",t)):console.log("audioBitrate must be a number greater than 0");break;case"enableAudioAEC":this.audioQuality.echoCancellation=!!t;break;case"enableAudioAGC":this.audioQuality.autoGainControl=!!t;break;case"enableAudioANS":this.audioQuality.noiseSuppression=!!t;break;case"setConnectRetryCount":"number"==typeof t&&t>=0&&t<=10?this.connectRetry.maxNum=t:console.log("connectRetryCount must be a number between 0 and 10");break;case"setConnectRetryDelay":"number"==typeof t&&t>=0&&t<=10?this.connectRetry.delay=t:console.log("connectRetryDelay must be a number between 0 and 10");break;default:console.log(e+" is not existed")}},e.prototype.startCamera=function(e){if(void 0===e&&(e=""),this.isVideoPushing)console.log("stream is pushing, please stop pushing first");else if(this.videoStream)console.log("video stream is existed");else{this.cameraStream||(this.cameraStream=new Me,this.cameraStream.init({onAddStream:this.onAddStream,onStopStream:this.onStopStream,onError:this.onStreamError,onSwitchStream:this.onSwitchStream})),this.videoStreamType="camera";var t=this.videoQuality,n=t.frameRate,r=t.width,i=t.height;this.cameraStream.startStream({deviceId:e||this.deviceManager.getCurrentDeviceId("video"),frameRate:n,resolution:{width:r,height:i}})}},e.prototype.stopCamera=function(){var e;this.isVideoPushing?console.log("stream is pushing, please stop pushing first"):"camera"===this.videoStreamType?this.videoStream?null===(e=this.cameraStream)||void 0===e||e.stopStream():console.log("video stream is not existed"):console.log("current video stream is not camera stream")},e.prototype.startMicrophone=function(e){if(void 0===e&&(e=""),this.isVideoPushing)console.log("stream is pushing, please stop pushing first");else if(this.audioStream)console.log("audio stream is existed");else{this.microphoneStream||(this.microphoneStream=new je,this.microphoneStream.init({onAddStream:this.onAddStream,onStopStream:this.onStopStream,onError:this.onStreamError,onSwitchStream:this.onSwitchStream}));var t=this.audioQuality,n=t.sampleRate,r=t.echoCancellation,i=t.noiseSuppression,o=t.autoGainControl;this.microphoneStream.startStream({deviceId:e||this.deviceManager.getCurrentDeviceId("audio"),sampleRate:n,echoCancellation:r,noiseSuppression:i,autoGainControl:o})}},e.prototype.stopMicrophone=function(){var e;this.isVideoPushing?console.log("stream is pushing, please stop pushing first"):this.audioStream?null===(e=this.microphoneStream)||void 0===e||e.stopStream():console.log("audio stream is not existed")},e.prototype.startScreenCapture=function(){if(this.isVideoPushing)console.log("stream is pushing, please stop pushing first");else if(this.videoStream)console.log("video stream is existed");else{this.screenStream||(this.screenStream=new Ve,this.screenStream.init({onAddStream:this.onAddStream,onStopStream:this.onStopStream,onError:this.onStreamError})),this.videoStreamType="screen";var e=this.videoQuality,t=e.frameRate,n=e.width,r=e.height;this.screenStream.startStream({frameRate:t,resolution:{width:n,height:r}})}},e.prototype.stopScreenCapture=function(){var e;this.isVideoPushing?console.log("stream is pushing, please stop pushing first"):"screen"===this.videoStreamType?this.videoStream?null===(e=this.screenStream)||void 0===e||e.stopStream():console.log("video stream is not existed"):console.log("current video stream is not screen stream")},e.prototype.startMediaFile=function(e){if(this.isVideoPushing)console.log("stream is pushing, please stop pushing first");else if(this.videoStream)console.log("video stream is existed");else if(this.audioStream)console.log("audio stream is existed");else if(this.playerView){if(De&&(this.cameraStream||this.screenStream||this.microphoneStream)){var t=this.playerView.parentElement;t.removeChild(this.playerView),this.playerView=this.createVideoEl(t)}if(!e||e instanceof File&&"video/mp4"===e.type){this.fileStream||(this.fileStream=new Xe,this.fileStream.init({onAddStream:this.onAddStream,onStopStream:this.onStopStream,onError:this.onStreamError})),this.videoStreamType="file";var n=this.videoQuality,r=n.frameRate,i=n.width,o=n.height;this.fileStream.startStream({file:e,frameRate:r,resolution:{width:i,height:o},playerView:this.playerView})}else console.log("File must be mp4 file")}else console.log("Please set render view first")},e.prototype.stopMediaFile=function(){var e;this.isVideoPushing?console.log("stream is pushing, please stop pushing first"):"file"===this.videoStreamType?this.videoStream?null===(e=this.fileStream)||void 0===e||e.stopStream():console.log("video stream is not existed"):console.log("current video stream is not file stream")},e.prototype.startPush=function(e){var t,n;null!==Ae(e)?this.isVideoPushing?console.log("stream is pushing, please stop pushing first"):this.videoStream||this.audioStream?(this.pushUrl=e,this.webrtcConnection||(this.webrtcConnection=new Le,this.webrtcConnection.init({onSetLocalDescription:this.onSetLocalDescription,onConnect:this.onConnect,onDisconnect:this.onDisconnect,onError:this.onWebRTCError,onStats:this.onStats})),this.webrtcConnection.setBandwidth("video",this.videoQuality.bitrate),this.webrtcConnection.setBandwidth("audio",this.audioQuality.bitrate),null===(n=(t=this.observer).onPushStatusUpdate)||void 0===n||n.call(t,Se.CONNECTING,"Connecting",null),this.webrtcConnection.initWebRTCConnect({direction:Ee.SEND,stream:this.getMediaStream()})):console.log("no stream for pushing"):console.log("push url is not correct")},e.prototype.stopPush=function(){var e;if(this.isVideoPushing){if(this.timeoutId&&(window.clearTimeout(this.timeoutId),this.timeoutId=null,this.connectRetry.curNum=0),this.pushUrl&&this.sessionId){try{ke({streamurl:this.pushUrl,sessionid:this.sessionId})}catch(e){console.log(e.message||"")}this.pushUrl=null,this.sessionId=null}null===(e=this.webrtcConnection)||void 0===e||e.disconnect()}else console.log("no stream is pushing")},e.prototype.isPushing=function(){return!(!this.videoStream&&!this.audioStream||!this.isVideoPushing)},e.prototype.getDeviceManager=function(){return this.deviceManager},e.prototype.setVideoMute=function(e){this.videoStream&&this.videoStream.getVideoTracks().forEach((function(t){t.enabled=!e}))},e.prototype.setAudioMute=function(e){this.audioStream&&this.audioStream.getAudioTracks().forEach((function(t){t.enabled=!e}))},e.prototype.setObserver=function(e){var t=this,n=Object.keys(this.observer);Object.keys(e).forEach((function(r){var i=e[r];n.includes(r)&&"function"==typeof i&&(t.observer[r]=i)}))},e.prototype.destroy=function(){var e;this.timeoutId&&(window.clearTimeout(this.timeoutId),this.timeoutId=null),this.videoStream&&"file"===this.videoStreamType&&(null===(e=this.fileStream)||void 0===e||e.stopStream(),this.videoStream=null,this.audioStream=null),this.videoStream&&(this.videoStream.getTracks().forEach((function(e){e.stop()})),this.videoStream=null),this.audioStream&&(this.audioStream.getTracks().forEach((function(e){e.stop()})),this.audioStream=null),this.playerView&&(this.playerView.pause(),this.playerView.srcObject=null,this.playerView.src="",this.playerView.parentElement.removeChild(this.playerView),this.playerView=null),this.webrtcConnection&&(this.webrtcConnection.disconnect(),this.webrtcConnection=null,this.lastStatsReport=null),this.cameraStream=null,this.microphoneStream=null,this.screenStream=null,this.fileStream=null,this.deviceManager=null,this.observer=null},e.prototype.createVideoEl=function(e){var t=document.createElement("video");return t.autoplay=!0,t.controls=!1,t.playsInline=!0,t.setAttribute("webkit-playsinline",""),t.setAttribute("x5-playsinline",""),t.setAttribute("style","max-width:100%;max-height:100%;object-fit:contain;display:block;margin:0 auto;"),e.appendChild(t),t},e.prototype.startVideoPlay=function(e){return r(this,void 0,void 0,(function(){var t,n;return i(this,(function(r){switch(r.label){case 0:if(!this.playerView)return[2];if(this.playerView.srcObject&&this.playerView.srcObject instanceof MediaStream)return this.playerView.srcObject.addTrack(e.getTracks()[0]),[2];(t=new MediaStream).addTrack(e.getTracks()[0]),this.playerView.srcObject=t,this.playerView.load(),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.playerView.play()];case 2:return r.sent(),console.log("play ok"),[3,4];case 3:return n=r.sent(),console.log("play failed",n),[3,4];case 4:return[2]}}))}))},e.prototype.stopVideoPlay=function(){var e=this;if(this.playerView){if(this.playerView.srcObject&&this.playerView.srcObject instanceof MediaStream)if(this.playerView.srcObject.getTracks().forEach((function(t){"ended"===t.readyState&&e.playerView.srcObject.removeTrack(t)})),this.playerView.srcObject.getTracks().length>0)return;this.playerView.pause(),this.playerView.srcObject=null,this.playerView.load()}},e.prototype.getMediaStream=function(){var e,t=null;return(null===(e=this.playerView)||void 0===e?void 0:e.srcObject)&&this.playerView.srcObject instanceof MediaStream?t=this.playerView.srcObject:(t=new MediaStream,[this.videoStream,this.audioStream].forEach((function(e){if(e){var n=e.getTracks();n.length>0&&t.addTrack(n[0])}}))),t},e.prototype.onAddStream=function(e,t){var n,r,i,o,s=!1,a=!1,c=e.getVideoTracks();if(c.length>0){if(this.videoStream)return void console.log("video stream is existed");this.videoStream=e,"camera"===t&&this.deviceManager.setCurrentDevice("video",c[0].getSettings().deviceId),s=!0}var d=e.getAudioTracks();if(d.length>0){if(this.audioStream)return void console.log("audio stream is existed");this.audioStream=e,"microphone"===t&&this.deviceManager.setCurrentDevice("audio",d[0].getSettings().deviceId),a=!0}"file"!==t&&this.startVideoPlay(e),s&&(null===(r=(n=this.observer).onCaptureFirstVideoFrame)||void 0===r||r.call(n)),a&&(null===(o=(i=this.observer).onCaptureFirstAudioFrame)||void 0===o||o.call(i))},e.prototype.onStopStream=function(e,t){var n,o;return r(this,void 0,void 0,(function(){var r;return i(this,(function(i){if(t&&"file"!==e){switch(r=null,e){case"camera":r=be.TXLIVE_WARNING_CAMERA_INTERRUPTED;break;case"microphone":r=be.TXLIVE_WARNING_MICROPHONE_INTERRUPTED;break;case"screen":r=be.TXLIVE_WARNING_SCREEN_CAPTURE_INTERRUPTED}null===(o=(n=this.observer).onWarning)||void 0===o||o.call(n,r,t,null)}return"file"!==e?(this.stopVideoPlay(),"microphone"!==e?(this.videoStream=null,"camera"===e&&this.deviceManager.setCurrentDevice("video","")):(this.audioStream=null,this.deviceManager.setCurrentDevice("audio",""))):(this.videoStream=null,this.audioStream=null),this.isVideoPushing&&this.stopPush(),[2]}))}))},e.prototype.onStreamError=function(e,t){var n,r,i=null;switch(t){case"camera":i=be.TXLIVE_WARNING_CAMERA_START_FAILED;break;case"microphone":i=be.TXLIVE_WARNING_MICROPHONE_START_FAILED;break;case"screen":i=be.TXLIVE_WARNING_SCREEN_CAPTURE_START_FAILED;break;case"file":i=be.TXLIVE_WARNING_MEDIA_FILE_START_FAILED}null===(r=(n=this.observer).onWarning)||void 0===r||r.call(n,i,e,null)},e.prototype.onSetLocalDescription=function(e){var t,n;return r(this,void 0,void 0,(function(){var o,s,a,c,d;return i(this,(function(l){switch(l.label){case 0:o=Ae(this.pushUrl),l.label=1;case 1:return l.trys.push([1,3,,4]),[4,(p={streamurl:this.pushUrl,sessionid:o+"_"+Oe(),localsdp:e},r(void 0,void 0,void 0,(function(){var e,t,n,r;return i(this,(function(i){switch(i.label){case 0:return[4,_e("https://webrtcpush.myqcloud.com/webrtc/v1/pushstream",p)];case 1:if(e=i.sent(),t=e.errcode,n=e.errmsg,r=e.remotesdp,0!==t)throw new Error("errCode:"+t+", errMsg:"+n);return[2,{remoteSdp:r,sessionId:p.sessionid}]}}))})))];case 2:return s=l.sent(),a=s.remoteSdp,c=s.sessionId,this.webrtcConnection.connect(a),this.sessionId=c,[3,4];case 3:return d=l.sent(),console.log(d.message),this.webrtcConnection.disconnect(),null===(n=(t=this.observer).onError)||void 0===n||n.call(t,be.TXLIVE_ERROR_REQUEST_FAILED,d.message,null),[3,4];case 4:return[2]}var p}))}))},e.prototype.onConnect=function(e){var t,n;console.log("TXLivePusher onConnect",e),e.code===Ce.SUCCESS&&(this.connectRetry.curNum=0,this.isVideoPushing=!0,null===(n=(t=this.observer).onPushStatusUpdate)||void 0===n||n.call(t,Se.ESTABLISHED,"Connected",null))},e.prototype.onDisconnect=function(e){var t,n;return r(this,void 0,void 0,(function(){var r,o=this;return i(this,(function(i){switch(i.label){case 0:if(this.isVideoPushing=!1,this.lastStatsReport=null,console.log("TXLivePusher onDisconnect",e),e.code!==Te.NEED_RECONNECT)return[3,6];if(!this.pushUrl||!this.sessionId)return[3,5];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,ke({streamurl:this.pushUrl,sessionid:this.sessionId})];case 2:return i.sent(),[3,4];case 3:return r=i.sent(),console.log(r.message||""),[3,4];case 4:this.sessionId=null,i.label=5;case 5:return this.timeoutId&&(window.clearTimeout(this.timeoutId),this.timeoutId=null),this.timeoutId=window.setTimeout((function(){var e,t,n,r,i,s,a;o.connectRetry.curNum+=1;var c=o.connectRetry,d=c.curNum,l=c.maxNum;d<=l?(console.log("current retry num: "+d+", max retry num: "+l),null===(e=o.webrtcConnection)||void 0===e||e.setBandwidth("video",o.videoQuality.bitrate),null===(t=o.webrtcConnection)||void 0===t||t.setBandwidth("audio",o.audioQuality.bitrate),null===(r=(n=o.observer).onPushStatusUpdate)||void 0===r||r.call(n,Se.RECONNECTING,"Reconnecting",null),null===(i=o.webrtcConnection)||void 0===i||i.initWebRTCConnect({direction:Ee.SEND,stream:o.getMediaStream()})):(null===(a=(s=o.observer).onPushStatusUpdate)||void 0===a||a.call(s,Se.DISCONNECTED,"Disconnected",null),o.connectRetry.curNum=0),o.timeoutId=null}),1e3*this.connectRetry.delay),[3,7];case 6:null===(n=(t=this.observer).onPushStatusUpdate)||void 0===n||n.call(t,Se.DISCONNECTED,"Disconnected",null),i.label=7;case 7:return[2]}}))}))},e.prototype.onWebRTCError=function(e){var t,n;null===(n=(t=this.observer).onError)||void 0===n||n.call(t,be.TXLIVE_ERROR_WEBRTC_FAILED,e,null)},e.prototype.onStats=function(e){var t,n,r=function(e,t){if(void 0===t&&(t=null),t){var n=null,r=null,i=null;if(e.forEach((function(e){"track"===e.type&&("video"===e.kind||e.frameWidth)&&(n=e.id),"outbound-rtp"===e.type&&("video"===e.kind||"video"===e.mediaType?r=e.id:"audio"!==e.kind&&"audio"!==e.mediaType||(i=e.id))})),r){var o=e.get(n),s=e.get(r),a=t.get(n),c=t.get(r);if(c){var d=(s.timestamp-c.timestamp)/1e3,l=void 0;s.framesPerSecond?l=s.framesPerSecond:s.framerateMean?l=s.framerateMean:(null==o?void 0:o.framesSent)&&(null==a?void 0:a.framesSent)&&(l=(o.framesSent-a.framesSent)/d);var p=void 0;s.bytesSent&&(p=8*(s.bytesSent-c.bytesSent)/d);var u=void 0;s.totalEncodeTime&&s.framesEncoded&&(u=s.framesEncoded-c.framesEncoded?(s.totalEncodeTime-c.totalEncodeTime)/(s.framesEncoded-c.framesEncoded)*1e3:s.totalEncodeTime/s.framesEncoded*1e3);var h=void 0;s.totalPacketSendDelay&&s.packetsSent&&(h=s.packetsSent-c.packetsSent?(s.totalPacketSendDelay-c.totalPacketSendDelay)/(s.packetsSent-c.packetsSent)*1e3:s.totalPacketSendDelay/s.packetsSent*1e3);var f=e.get(i),m=t.get(i),v=void 0;return(null==f?void 0:f.bytesSent)&&(null==m?void 0:m.bytesSent)&&(v=8*(f.bytesSent-m.bytesSent)/d),{timestamp:s.timestamp,video:{bitrate:p&&Number(p.toFixed(2)),framesPerSecond:l&&parseInt(l.toString(),10),frameWidth:null==o?void 0:o.frameWidth,frameHeight:null==o?void 0:o.frameHeight,framesEncoded:s.framesEncoded,framesSent:null==o?void 0:o.framesSent,packetsSent:s.packetsSent,nackCount:s.nackCount,firCount:s.firCount,pliCount:s.pliCount,frameEncodeAvgTime:u&&Number(u.toFixed(2)),packetSendDelay:h&&Number(h.toFixed(2))},audio:{bitrate:v&&Number(v.toFixed(2)),packetsSent:null==f?void 0:f.packetsSent}}}}}}(e,this.lastStatsReport);this.lastStatsReport=e,r&&(null===(n=(t=this.observer).onStatisticsUpdate)||void 0===n||n.call(t,r))},e.prototype.onSwitchDevice=function(e,t){if("video"===e)if(this.videoStream&&"camera"===this.videoStreamType&&this.cameraStream){var n=this.videoQuality,r=n.frameRate,i=n.width,o=n.height;this.cameraStream.switchStream({deviceId:t,frameRate:r,resolution:{width:i,height:o}})}else console.log("Failed to switch camera device");if("audio"===e)if(this.audioStream&&"file"!==this.videoStreamType&&this.microphoneStream){var s=this.audioQuality,a=s.sampleRate,c=s.echoCancellation,d=s.noiseSuppression,l=s.autoGainControl;this.microphoneStream.switchStream({deviceId:t,sampleRate:a,echoCancellation:c,noiseSuppression:d,autoGainControl:l})}else console.log("Failed to switch microphone device")},e.prototype.onSwitchStream=function(e,t){var n,s;return r(this,void 0,void 0,(function(){var r,a,c,d,l,p,u,h;return i(this,(function(i){switch(i.label){case 0:return r=null,a=null,c=e.getVideoTracks(),"camera"===t&&c.length>0&&(l=o(this.videoStream.getVideoTracks(),1),r=l[0],p=o(c,1),a=p[0],this.videoStream=e,this.deviceManager.setCurrentDevice("video",a.getSettings().deviceId)),d=e.getAudioTracks(),"microphone"===t&&d.length>0&&(u=o(this.audioStream.getAudioTracks(),1),r=u[0],h=o(d,1),a=h[0],this.audioStream=e,this.deviceManager.setCurrentDevice("audio",a.getSettings().deviceId)),r&&a?((null===(n=this.playerView)||void 0===n?void 0:n.srcObject)&&this.playerView.srcObject instanceof MediaStream&&(this.playerView.srcObject.removeTrack(r),this.playerView.srcObject.addTrack(a)),this.isVideoPushing?[4,null===(s=this.webrtcConnection)||void 0===s?void 0:s.replaceTrack(a)]:[3,2]):[2];case 1:i.sent(),i.label=2;case 2:return r.stop(),[2]}}))}))},e}();return Je.__init(),Je}));